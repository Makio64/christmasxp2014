(function(){$(function(a){return function(){var b,c,d,e,f,g;for(a.is_firefox=navigator.userAgent.toLowerCase().indexOf("firefox")>-1,a.key="yoJC2IorC28DFEF1FS",a.gifhyAPI_search="http://api.giphy.com/v1/gifs/search?",a.gifhyAPI_random="http://api.giphy.com/v1/gifs/random?",a.random_tags=["christmas","christmas tree","santa","santa claus","xmas","winter","grandma","grandmas","food","cat","dog","animal","lol","funny","cute","fail","reactions"],a.gifFPS=10,a.cameraFixPosFar=new THREE.Vector3(0,150,800),a.cameraFixPosZoom=new THREE.Vector3(0,150,550),a.cameraBasePos=a.cameraFixPosFar.clone(),a.camPos=a.cameraFixPosFar.clone(),a.isCameraFree=!1,a.loadingSprites=[THREE.ImageUtils.loadTexture("img/loading_sprites/l.png"),THREE.ImageUtils.loadTexture("img/loading_sprites/o.png"),THREE.ImageUtils.loadTexture("img/loading_sprites/a.png"),THREE.ImageUtils.loadTexture("img/loading_sprites/d.png"),THREE.ImageUtils.loadTexture("img/loading_sprites/i.png"),THREE.ImageUtils.loadTexture("img/loading_sprites/n.png"),THREE.ImageUtils.loadTexture("img/loading_sprites/g.png")],a.ambientColdColor=5965,a.ambientWarmColor=10902541,a.useMicrophone=!1,a.gifIsloaded=!1,a.isLightOn=!1,a.isInteractive=!1,a.isMouseOverGirl=!1,a.isMouseOverGif=!1,a.blowMeter=0,a.volume=0,a.volumeThreshold=35,a.blowThreshold=10,a.averageVolume=0,a.volumeSamples=function(){for(g=[],c=0;30>c;c++)g.push(c);return g}.apply(this),f=a.volumeSamples,d=0,e=f.length;e>d;d++)b=f[d],a.volumeSamples[b]=0;a.cangleLightIntensity=1.5,a.is_firefox&&(a.volumeThreshold*=.35),a.accessTrials=0,a.API_ACCESS_MAX_TRIALS=5,a.howlingSound=$("#howling").get(0),a.lightMatchSound=$("#light").get(0),a.blowMatchSound=$("#blow").get(0),a.bgm=$("#bgm").get(0),a.hohoho=$("#santavoice").get(0),a.wow=$("#wow").get(0),a.init=function(){return $("#start").on("click",function(a){return function(){return $("#start").html("Loading..."),$("#start").addClass("loading"),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,navigator.getUserMedia?navigator.getUserMedia({audio:!0},a.gotStream,a.streamError):init2(),$("#start").off("click")}}(this))},a.init2=function(){return a.checkAudio(),a.loadModels()},a.init3=function(){return a.initStage(),a.initWorker(),a.intro(),a.animate()},a.loadModels=function(){var c,d,e,f;return a.modelsToload=4,c=new THREE.JSONLoader,c.load("models/character_rigged2.json",function(c,d){var e,f,g,h,i,j,k;for(c.computeBoundingBox(),a.character=new THREE.SkinnedMesh(c,new THREE.MeshFaceMaterial(d)),g=0,i=d.length;i>g;g++)e=d[g],e.skinning=!0;for(a.character.scale.set(30,30,30),a.character.position.z=100,a.animations=[],k=a.character.geometry.animations,h=0,j=k.length;j>h;h++)b=k[h],f={name:b.name,animation:new THREE.Animation(a.character,b)},a.animations.push(f);return 0===--a.modelsToload?init3():void 0}),d=new THREE.JSONLoader,d.load("models/match.json",function(b,c){var d,e,f;for(a.match=new THREE.Mesh(b,new THREE.MeshFaceMaterial(c)),e=0,f=c.length;f>e;e++)d=c[e],"Match_head"===d.name&&(a.matchHeadMaterial=d,a.originalMatchHeadColor=d.color.clone());return 0===--a.modelsToload?init3():void 0}),e=new THREE.JSONLoader,e.load("models/character_match_lighten.json",function(b,c){return a.character_match=new THREE.Mesh(b,new THREE.MeshFaceMaterial(c)),0===--a.modelsToload?init3():void 0}),f=new THREE.JSONLoader,f.load("models/stage2.json",function(b,c){return a.stage=new THREE.Mesh(b,new THREE.MeshFaceMaterial(c)),0===--a.modelsToload?init3():void 0})},a.checkAudio=function(){return a.howlingSound.paused?a.howlingSound.play():void 0},a.playAnimation=function(c,d){var e,f,g;for(null==d&&(d=!0),a.currentAnimation&&a.currentAnimation.stop(),g=a.animations,e=0,f=g.length;f>e;e++)b=g[e],b.name===c&&(a.animationComplete=!1,b.animation.loop=d,b.animation.play(),a.currentAnimation=b.animation);return null},a.enableBlow=!1,a.gotStream=function(b){return window.AudioContext=window.AudioContext||window.webkitAudioContext,a.audioContext=new AudioContext,a.mediaStreamSource=a.audioContext.createMediaStreamSource(b),a.useMicrophone=!0,a.analyzer=a.audioContext.createAnalyser(),a.analyzer.smoothingTimeConstant=.3,a.analyzer.fftSize=1024,a.jsNode=a.audioContext.createScriptProcessor(2048,1,1),a.jsNode.onaudioprocess=function(){var b;if(a.gifIsloaded)if(b=new Uint8Array(a.analyzer.frequencyBinCount),a.analyzer.getByteFrequencyData(b),a.volume=getAverageVolume(b),a.volumeSamples.push(a.volume),a.volumeSamples.shift(),a.averageVolume=a.getAverageVolume(a.volumeSamples),a.volume>a.averageVolume+a.volumeThreshold){if(a.blowMeter++,a.blowMeter>a.blowThreshold&&(a.blowMeter=a.blowThreshold,a.enableBlow))return a.removeGif(),a.blowMeter=0}else if(--a.blowMeter<0)return a.blowMeter=0},a.mediaStreamSource.connect(a.analyzer),a.analyzer.connect(a.jsNode),a.jsNode.connect(audioContext.destination),a.init2()},a.getAverageVolume=function(a){var c,d,e;for(c=0,d=0,e=a.length;e>d;d++)b=a[d],c+=b;return c/a.length},a.streamError=function(b){return console.log(b),a.useMicrophone=!1,a.init2()},a.searchGif=function(c){var d;return d=""+a.gifhyAPI_search+"q="+c+"&api_key="+a.key,jQuery.ajax(d,{crossDomain:!0}).done(function(c){return a.accessTrials=0,b=Math.floor(Math.random()*c.data.length),console.log(c.data[b]),a.gifPageUrl=c.data[b].url,a.videoSrc=c.data[b].images.original.mp4,a.gifWidth=c.data[b].images.downsized.width,a.gifHeight=c.data[b].images.downsized.height,a.gifUrl=c.data[b].images.downsized.url,a.gifFrames=c.data[b].images.original.frames,a.setupGif()}).error(function(){return++a.accessTrials,a.accessTrials<a.API_ACCESS_MAX_TRIALS?a.getRandomGif(c):void 0})},a.currentTag=null,a.hubURL="http://prty.nyc/christmas/image.php",a.getRandomGif=function(b){var c;return a.currentTag=b,c=""+a.gifhyAPI_random+"tag="+b+"&api_key="+a.key,jQuery.ajax(c,{crossDomain:!0}).done(function(b){return console.log(b),a.accessTrials=0,a.gifPageUrl=b.data.url,a.videoSrc=b.data.image_mp4_url,a.gifWidth=b.data.image_width,a.gifHeight=b.data.image_height,a.gifUrl=b.data.image_url,a.gifFrames=b.data.image_frames,a.setupGif()}).error(function(){return++a.accessTrials,a.accessTrials<a.API_ACCESS_MAX_TRIALS?a.getRandomGif(b):void 0})},a.setupGif=function(){var b,c;return a.gifIsloaded=!1,a.gifMaterial.opacity=0,a.gifWidth>a.gifHeight?(b=a.gifHeight/100*400/a.gifWidth,a.gifPlane.scale.set(4,b,1)):(c=a.gifWidth/100*300/a.gifHeight,a.gifPlane.scale.set(c,3,1)),a.loadImage(a.hubURL+"?src="+a.gifUrl)},a.idleId=0,a.goIdle=function(){return a.matchHolder.visible&&(a.matchHolder.visible=!1),a.isInteractive||(a.isInteractive=!0),a.cameraBasePos!==a.cameraFixPosFar&&(a.cameraBasePos=a.cameraFixPosFar),clearTimeout(a.idleId),a.idleId=setTimeout(function(){return a.onAnimationComplete=a.goIdle,Math.random()<.5?a.playAnimation("idle",!1):a.playAnimation("cold",!1)},1500*Math.random())},a.countGifLoaded=0,a.reloadGif=function(){var b;return a.countGifLoaded++,a.onAnimationComplete=null,a.isIntroPlaying?a.searchGif("christmas+tree"):(b=a.random_tags[Math.floor(a.random_tags.length*Math.random())],a.getRandomGif(b)),a.scene.children.indexOf(a.ctaSprite)>-1&&TweenMax.to(a.ctaSprite.material,.5,{opacity:0,ease:Linear.easeNone}),a.cameraBasePos=a.cameraFixPosZoom,a.matchHolder.visible=!0,clearTimeout(a.idleId),a.matchHeadMaterial.color.copy(a.originalMatchHeadColor),a.playAnimation("takeoutmatch",!1),setTimeout(function(){return a.lightMatchSound.play(),a.isLightOn=!0,a.fireMesh.visible=!0,a.matchHeadMaterial.color.setRGB(0,0,0)},900),setTimeout(function(){return a.loadingSparkCounter=0,a.loadingSpark.visible=!0},2e3)},a.showGifAnimation=function(){var b,c,d,e;return a.loadingSpark.visible=!1,a.scene.add(a.gifPlane),a.character.visible=!1,a.character_match.visible=!0,b=a.ambientLight.color.clone(),c=new THREE.Color(a.ambientWarmColor),d={r:b.r,g:b.g,b:b.b},a.ambientTween=TweenMax.to(d,4,{r:c.r,g:c.g,b:c.b,ease:Linear.easeNone,onUpdate:function(){return a.ambientLight.color.setRGB(d.r,d.g,d.b)}}),TweenMax.to(a.gifMaterial,2,{opacity:1,ease:Linear.easeNone}),2===a.countGifLoaded&&checkMicCTA(),/santa/.test(a.currentTag)?(a.hohoho.currentTime=0,a.hohoho.play()):a.bgm.play(),a.howlingSound.pause(),/grandma/.test(a.currentTag)&&(a.wow.play(),a.scriptDiv.html("G R A N D M A !!!"),$("#container").append(a.scriptDiv)),setTimeout(function(){return a.useMicrophone?a.enableBlow=!0:void 0},2e3),e=a.gifFrames*(3*Math.random()+3)*a.gifFPS+7500*Math.random()+1e4,clearTimeout(a.removeId),a.removeId=setTimeout(a.removeGif,e)},a.removeGif=function(){return a.gifIsloaded=!1,clearTimeout(a.removeId),a.scene.remove(a.gifPlane),a.isLightOn=!1,a.fireMesh.visible=!1,a.candleLight.intensity=0,a.matchHeadMaterial.color.setRGB(0,0,0),a.character.visible=!0,a.character_match.visible=!1,a.blowMatchSound.play(),a.ambientTween.kill(),a.ambientLight.color.set(a.ambientColdColor),a.bgm.pause(),a.hohoho.pause(),a.howlingSound.currentTime=0,a.howlingSound.play(),a.scriptDiv.remove(),a.enableBlow=!1,a.onAnimationComplete=a.isIntroPlaying?a.intro2:a.goIdle,a.playAnimation("putbackmatch",!1),console.log("removed")},a.checkMicCTA=function(){return a.useMicrophone?(a.showedMicrophoneCta=!0,a.ctaSprite.material.map=a.ctaTextures[2],TweenMax.to(a.ctaSprite.material,.5,{opacity:1,ease:Linear.easeNone,delay:3,onComplete:function(){return TweenMax.to(a.ctaSprite.material,.5,{opacity:.3,ease:Linear.easeNone,repeat:-1,yoyo:!0})}}),setTimeout(function(){return TweenMax.to(a.ctaSprite.material,.5,{opacity:0,ease:Linear.easeNone,onComplete:function(){return a.scene.remove(a.ctaSprite)}})},1e4)):a.scene.children.indexOf(a.ctaSprite)>-1?a.scene.remove(a.ctaSprite):void 0},a.tmpCanvas=document.createElement("canvas"),a.transparency=null,a.delay=null,a.disposalMethod=null,a.lastDisposalMethod=null,a.frame=null,a.frameCount=0,a.textures=[],a.initWorker=function(){return a.worker=new Worker("js/libs/Gif_worker.js"),a.worker.addEventListener("message",function(b){return"hdr"===b.data.cmd&&a.doHdr(b.data.data),"gce"===b.data.cmd&&a.doGCE(b.data.data),"img"===b.data.cmd&&a.doImg(b.data.data),"eof"===b.data.cmd?(a.gifIsloaded=!0,a.pushFrame(),console.log("eof"),void a.showGifAnimation()):"error"===b.data?a.removeGif():void 0},!1)},a.loadImage=function(b){var c;c=new XMLHttpRequest,c.open("GET",b,!0),c.withCredentials=!1,c.overrideMimeType("text/plain; charset=x-user-defined"),a.frameCount=0,a.textures=[],c.onload=function(){var b;b=c.responseText,a.worker.postMessage({cmd:"parseGIF",arrayBuffer:b})},c.send(null)},a.clear=function(){this.transparency=null,this.delay=null,this.lastDisposalMethod=this.disposalMethod,this.disposalMethod=null,this.frame=null},a.doHdr=function(b){a.hdr=b,a.tmpCanvas.width=a.hdr.width,a.tmpCanvas.height=a.hdr.height},a.doGCE=function(b){a.pushFrame(),a.clear(),a.transparency=b.transparencyGiven?b.transparencyIndex:null,a.delay=b.delayTime,a.disposalMethod=b.disposalMethod},a.pushFrame=function(){var b,c,d;frame&&(b=document.createElement("canvas"),b.width=a.tmpCanvas.width,b.height=a.tmpCanvas.height,c=b.getContext("2d"),c.drawImage(a.tmpCanvas,0,0,a.tmpCanvas.width,a.tmpCanvas.height),d=new THREE.Texture(b),d.minFilter=THREE.LinearFilter,d.magFilter=THREE.LinearFilter,d.wrapS=THREE.ClampToEdgeWrapping,d.wrapT=THREE.ClampToEdgeWrapping,d.needsUpdate=!0,a.textures.push(d),a.frameCount++)},a.doImg=function(b){var c,d;a.frame||(a.frame=a.tmpCanvas.getContext("2d")),d=b.lctFlag?b.lct:a.hdr.gct,c=a.frame.getImageData(b.leftPos,b.topPos,b.width,b.height),b.pixels.forEach(function(b,e){a.transparency!==b?(c.data[4*e+0]=d[b][0],c.data[4*e+1]=d[b][1],c.data[4*e+2]=d[b][2],c.data[4*e+3]=255):(2===a.lastDisposalMethod||3===a.lastDisposalMethod)&&(c.data[4*e+3]=0)}),a.frame.putImageData(c,b.leftPos,b.topPos)},a.doNothing=function(){},a.intro=function(){var b,c,d,e,f;return a.isIntroPlaying=!0,$("#container").css({opacity:0}),a.camera.position.copy(a.cameraFixPosFar),a.cameraTarget.copy(a.character.position),a.cameraTarget.y+=100,a.prologueDiv=$("<div id='prologue_div'></p>"),a.prologueDiv.css({"font-size":"2vw","text-align":"center","line-height":2,"z-index":"20","letter-spacing":"2px","text-shadow":"1px 1px 3px rgba(0, 0, 0, 1.00)",position:"absolute",width:"50%",height:"100px",top:0,left:0,bottom:0,right:0,margin:"auto",overflow:"visible",opacity:0}),a.prologueDiv.html($("#prologue>p")),$(document.body).append(a.prologueDiv),a.scriptDiv=$("<div id='script_div'></p>"),a.scriptDiv.css({"font-size":"2vw",position:"absolute",width:"100%",bottom:"25px","text-align":"center","z-index":"20","letter-spacing":"2px",overflow:"visible"}),a.scriptDiv.addClass("text_outline"),$("#container").append(a.scriptDiv),e=$("#intro_script>p"),d=function(b){return a.scriptDiv.html(e[b])},f=new TimelineMax,a.playAnimation("idle",!0),f.to($("#intro"),2,{autoAlpha:0,ease:Linear.easeNone}),f.fromTo(a.prologueDiv,2,{autoAlpha:0},{autoAlpha:1,ease:Linear.easeNone}),f.to(a.prologueDiv,2,{autoAlpha:0,ease:Linear.easeNone},"+=4"),f.to($("#container"),5,{alpha:1,ease:Linear.easeNone}),b=a.cameraTarget.clone(),b.sub(a.camera.position),b.normalize().multiplyScalar(400),b.add(a.camera.position),a.camera.position.x+=100,a.camera.position.y+=400,a.camera.position.z-=500,f.to(a.camera.position,8,{x:b.x,y:b.y,z:b.z,ease:Cubic.easeInOut},"-=5"),f.addLabel("script"),f.addCallback(d,"script+=1",[0]),f.addCallback(d,"script+=3",[1]),f.addCallback(d,"script+=8",[2]),f.addCallback(a.playAnimation,"script+=8",["cold",!1]),f.addCallback(d,"script+=12",[3]),f.addCallback(d,"script+=16",[4]),f.addLabel("movecam"),f.to(a.camera.position,3,{x:a.cameraBasePos.x,y:a.cameraBasePos.y,z:a.cameraBasePos.z,ease:Cubic.easeInOut},"movecam+0.5"),f.to(a.cameraTarget,3,{x:0,y:150,z:0,ease:Cubic.easeInOut},"movecam+=0.5"),f.to(a.ctaSprite.material,1,{opacity:1,ease:Linear.easeNone}),f.addLabel("firsttry"),c=function(){return TweenMax.to(a.ctaSprite.material,.5,{opacity:.3,ease:Linear.easeNone,repeat:-1,yoyo:!0}),a.scriptDiv.remove(),a.isInteractive=!0,a.isCameraFree=!0,a.goIdle()},f.addCallback(c,"firsttry+=0.5")},a.intro2=function(){var b,c,d;return console.log("intro2"),a.isInteractive=!1,a.isCameraFree=!1,a.onAnimationComplete=null,c=$("#intro_script2>p"),b=function(b){return a.scriptDiv.html(c[b])},a.scriptDiv.html(""),$("#container").append(a.scriptDiv),d=new TimelineMax,d.addLabel("script"),d.addCallback(b,"script",[0]),d.addCallback(b,"script+=4",[1]),d.addCallback(b,"script+=8",[2]),d.addCallback(function(){return a.scriptDiv.remove(),a.isIntroPlaying=!1,a.isInteractive=!0,a.isCameraFree=!0,a.ctaSprite.material.map=a.ctaTextures[1],TweenMax.to(a.ctaSprite.material,1,{opacity:1,ease:Linear.easeNone,onComplete:function(){return TweenMax.to(a.ctaSprite.material,.5,{opacity:.3,ease:Linear.easeNone,repeat:-1,yoyo:!0})}}),a.goIdle()},"script+=12")},a.loadingSparkCounter=0,a.initStage=function(){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;for(a.clock=new THREE.Clock,v=window.innerWidth,u=window.innerHeight,a.camera=new THREE.PerspectiveCamera(50,v/u,1,1e4),a.cameraTarget=new THREE.Vector3(0,0,0),a.scene=new THREE.Scene,a.renderer=new THREE.WebGLRenderer({antialias:!0}),a.renderer.setSize(v,u),a.renderer.sortObject=!0,a.renderer.shadowMapEnabled=!0,$("#container")[0].appendChild(a.renderer.domElement),a.scene.add(a.character),a.character.rotation.y=30*Math.PI/180,a.character.position.x=-180,a.character.castShadow=!0,a.character.receiveShadow=!1,a.character_match.position.copy(a.character.position),a.character_match.rotation.copy(a.character.rotation),a.character_match.scale.copy(a.character.scale),a.character_match.visible=!1,a.character_match.castShadow=!0,a.character_match.receiveShadow=!1,a.scene.add(a.character_match),a.matchHolder=new THREE.Object3D,a.match.position.set(5,0,-25),a.match.rotation.set(-Math.PI/2,0,-30*Math.PI/180),a.match.scale.set(30,30,30),a.matchHolder.add(a.match),a.scene.add(a.matchHolder),a.match.castShadow=!0,f=THREE.ImageUtils.loadTexture("img/match_fire.jpg"),e=new THREE.SpriteMaterial({map:f,blending:THREE.AdditiveBlending,useScreenCoordinates:!1,transparent:!0}),a.fireMesh=new THREE.Sprite(e),a.fireMesh.scale.set(60,60,1),a.fireMesh.visible=!1,d=a.match.rotation.clone(),t=new THREE.Vector3(0,1,0),t.applyEuler(d),t.multiplyScalar(30),t.add(a.match.position),a.candleLight=new THREE.PointLight(16751152,0,700),a.candleLight.position.copy(t),a.candleLight.add(a.fireMesh),a.matchHolder.add(a.candleLight),a.loadingSpark=new THREE.Object3D,a.loadingPlanes=[],k=new THREE.PlaneBufferGeometry(14,14,0,0),y=a.loadingSprites,w=0,x=y.length;x>w;w++)r=y[w],l=new THREE.MeshBasicMaterial({map:r,blending:THREE.AdditiveBlending,side:THREE.DoubleSide,transparent:!0,depthTest:!1}),m=new THREE.Mesh(k,l),a.loadingPlanes.push(m),a.loadingSpark.add(m);for(a.loadingSpark.position.copy(t),a.loadingSpark.visible=!1,a.matchHolder.add(a.loadingSpark),a.ctaTextures=[THREE.ImageUtils.loadTexture("img/cta1.png"),THREE.ImageUtils.loadTexture("img/cta2.png"),THREE.ImageUtils.loadTexture("img/cta3.png")],c=new THREE.SpriteMaterial({map:a.ctaTextures[0],useScreenCoordinates:!1,transparent:!0,opacity:0}),a.ctaSprite=new THREE.Sprite(c),a.ctaSprite.scale.set(260,60,1),a.ctaSprite.position.copy(a.character.position),a.ctaSprite.position.y+=260,a.scene.add(a.ctaSprite),a.gifTextrue=new THREE.Texture,a.gifMaterial=new THREE.MeshLambertMaterial({map:a.gifTextrue,color:6710886,transparent:!0,blending:THREE.AdditiveBlending,depthTest:!0}),g=new THREE.PlaneBufferGeometry(100,100,10,10),a.gifPlane=new THREE.Mesh(g,a.gifMaterial),a.gifPlane.position.x=60,a.gifPlane.position.y=250,a.gifPlane.position.z=-125,a.scene.add(a.gifPlane),a.stage.scale.set(30,30,30),a.stage.receiveShadow=!0,a.scene.add(a.stage),g=new THREE.BoxGeometry(90,135,3),i=new THREE.MeshBasicMaterial({color:16711680,opacity:0,transparent:!0,depthTest:!1}),a.poster1=new THREE.Mesh(g,i),a.poster1.position.set(340,158,-145),a.scene.add(a.poster1),a.poster2=new THREE.Mesh(g,i),a.poster2.position.set(455,150,-145),a.poster2.rotation.z=.2,a.scene.add(a.poster2),j=400,b={size:{type:"f",value:null}},s={time:{type:"f",value:0},color:{type:"c",value:new THREE.Color(16777215)},texture:{type:"t",value:THREE.ImageUtils.loadTexture("img/snowflake.png")}},q=new THREE.ShaderMaterial({uniforms:s,attributes:b,vertexShader:document.getElementById("vertexshader").textContent,fragmentShader:document.getElementById("fragmentshader").textContent,blending:THREE.AdditiveBlending,depthTest:!1,transparent:!0}),p=new THREE.BufferGeometry,n=new Float32Array(3*j),o=new Float32Array(j),t=0;j>t;)o[t]=40+40*Math.random(),n[3*t+0]=800*(2*Math.random()-1),n[3*t+1]=800*(2*Math.random()-1),n[3*t+2]=800*-Math.random(),t++;return p.addAttribute("position",new THREE.BufferAttribute(n,3)),p.addAttribute("size",new THREE.BufferAttribute(o,1)),a.snow=new THREE.PointCloud(p,q),a.snow.position.z=a.cameraFixPosFar.z,a.scene.add(a.snow),a.spotLight=new THREE.SpotLight(16767404,1.5),a.spotLight.position.set(200,500,500),h=new THREE.Object3D,h.position.set(60,300,0),a.scene.add(h),a.spotLight.target=h,a.spotLight.castShadow=!0,a.spotLight.shadowMapWidth=1024,a.spotLight.shadowMapHeight=1024,a.spotLight.shadowCameraNear=200,a.spotLight.shadowCameraFar=1500,a.spotLight.shadowBias=1e-4,a.spotLight.shadowDarkness=.3,a.scene.add(a.spotLight),a.pointLight=new THREE.PointLight(9745663,1.4),a.pointLight.position.set(0,500,350),a.scene.add(a.pointLight),a.ambientLight=new THREE.AmbientLight(a.ambientColdColor),a.scene.add(a.ambientLight),a.raycaster=new THREE.Raycaster,a.mouse={x:0,y:0},$(document).on("mousemove",a.onMouseMove),$(document.body).on("touchmove",a.onMouseMove),$(document.body).on("mousedown",a.onClick),$(document.body).on("touchstart",a.onTouch),$(window).on("resize",a.layout),a.layout()},a.onMouseMove=function(b){var c;return c=b.originalEvent.touches||b.touches,c?(a.mouse.x=c[0].clientX/window.innerWidth*2-1,a.mouse.y=2*-(c[0].clientY/window.innerHeight)+1):(a.mouse.x=b.clientX/window.innerWidth*2-1,a.mouse.y=2*-(b.clientY/window.innerHeight)+1,a.detectObject(a.mouse.x,a.mouse.y))},a.mouseOverObject=null,a.detectObject=function(c,d){var e,f,g,h,i,j,k,l;if(j=new THREE.Vector3(c,d,1).unproject(a.camera),a.raycaster.set(a.camera.position,j.sub(a.camera.position).normalize()),i=raycaster.intersectObjects(a.scene.children),i.length>0){for(e=!1,f=!1,g=!1,h=!1,k=0,l=i.length;l>k;k++)b=i[k],b.object===a.character&&(e=!0),b.object===a.gifPlane&&(f=!0),b.object===a.poster1&&(g=!0),b.object===a.poster2&&(h=!0);if(!(e||f||g||h))return a.mouseOverObject=null,document.body.style.cursor="auto";if(e&&!a.isMouseOverGirl&&a.isInteractive&&(document.body.style.cursor="pointer",a.mouseOverObject=a.character),f&&!a.isMouseOverGif&&a.gifIsloaded&&(document.body.style.cursor="pointer",a.mouseOverObject=a.gifPlane),g&&(document.body.style.cursor="pointer",a.mouseOverObject=a.poster1),h)return document.body.style.cursor="pointer",a.mouseOverObject=a.poster2}},a.onTouch=function(b){var c;return c=b.originalEvent.touches||b.touches,console.log(b),a.mouse.x=c[0].clientX/window.innerWidth*2-1,a.mouse.y=2*-(c[0].clientY/window.innerHeight)+1,a.detectObject(a.mouse.x,a.mouse.y),a.isClicked?void 0:a.onClick()},a.onClick=function(b){return b.preventDefault(),a.mouseOverObject===a.character&&a.isInteractive?(a.isInteractive=!1,document.body.style.cursor="auto",reloadGif()):a.mouseOverObject===a.gifPlane?window.open(a.gifPageUrl,"_blank"):a.mouseOverObject===a.poster1?window.open("http://giphy.com/","_blank"):a.mouseOverObject===a.poster2?window.open("https://twitter.com/muroicci","_blank"):void 0},a.layout=function(){var b,c,d;return d=window.innerWidth,c=window.innerHeight,b=9*d/16,b>c&&(b=c),a.camera.aspect=d/b,a.camera.updateProjectionMatrix(),a.renderer.setSize(d,b),$("#container").css({position:"absolute",top:"50%","margin-top":-b/2})},a.animate=function(){return requestAnimationFrame(a.animate),!a.currentAnimation||a.currentAnimation.isPlaying||a.animationComplete||(a.animationComplete=!0,a.onAnimationComplete&&a.onAnimationComplete()),a.render()},a.counter=0,a.now=Date.now(),a.then=Date.now(),a.interval=1e3/a.gifFPS,a.delta=0,a.noise=new SimplexNoise,a.render=function(){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;if(d=a.clock.elapsedTime,c=a.clock.getDelta(),a.isCameraFree&&(a.camPos.x=a.cameraBasePos.x+150*a.mouse.x,a.camPos.y=a.cameraBasePos.y+100*a.mouse.y,a.camPos.z=a.cameraBasePos.z,a.camera.position.add(a.camPos.clone().sub(a.camera.position).multiplyScalar(.025))),a.camera.lookAt(a.cameraTarget),THREE.AnimationHandler.update(c),b=a.scene.getObjectByName("L_hand"),k=new THREE.Vector3,k.setFromMatrixPosition(b.matrixWorld),l=b.getWorldQuaternion(),a.matchHolder.position.set(k.x,k.y,k.z),a.matchHolder.quaternion.copy(l),a.now=Date.now(),a.delta=a.now-a.then,a.delta>a.interval&&a.gifIsloaded&&(a.then=a.now-a.delta%a.interval,a.counter++,a.counter>=a.gifFrames&&(a.counter=1),a.isLightOn&&a.gifIsloaded&&(o=a.textures[a.counter],a.gifPlane.material.map=o)),a.isLightOn&&(p=a.cangleLightIntensity+.4*Math.sin(60*a.clock.getElapsedTime()),a.candleLight.intensity=p,a.fireMesh.material.opacity=p,a.fireMesh.scale.y=50*p-a.blowMeter*Math.random()*10,a.fireMesh.material.rotation=(2*Math.random()-1)*a.blowMeter*5*.01745329251,!a.gifIsloaded))for(a.loadingSpark.lookAt(a.matchHolder.position),e=-180,h=10,g=a.loadingPlanes.length,a.loadingSparkCounter+=.008,a.loadingSparkCounter>1+h/g&&(a.loadingSparkCounter=0),s=a.loadingPlanes,f=q=0,r=s.length;r>q;f=++q)i=s[f],i.rotation.x=Math.PI/2,i.rotation.z=Math.PI,a.loadingSparkCounter<=f/g?(i.position.set(0,0,30*-Math.random()),i.rotation.y=Math.PI/2,i.material.opacity=0):(p=a.map_range(a.loadingSparkCounter,f/g,f/g+h/g,0,1),j=i.position.clone(),j.multiplyScalar(.005+5e-4*f),m=a.noise.noise(j.x,j.z),i.position.x=50*p*Math.sin(a.loadingSparkCounter*Math.PI*2)+p*p*m*40,i.position.y=50*p*Math.cos(a.loadingSparkCounter*Math.PI*2)+p*p*m*40,i.position.z=p*p*e+25*m-30,i.rotation.y=1*Math.sin(10*p),i.rotation.x=.3*Math.sin(p*f)+Math.PI/2,i.rotation.z=.2*Math.cos(p*f)+Math.PI,i.material.opacity=(1-p)*(.5*Math.random()+.5));for(n=a.snow.geometry.attributes.position.array,f=0,g=n.length;g>f;)n[f]+=1.5*Math.sin(.5*(d+f%3)),f++,n[f]<-10?n[f]=800+800*Math.random():n[f]-=1+f%3,f++,n[f]+=1*Math.cos(.4*(d+f%4)),f++;return a.snow.material.uniforms.time.value=d,a.snow.geometry.attributes.position.needsUpdate=!0,a.renderer.render(a.scene,a.camera)},a.map_range=function(a,b,c,d,e){return d+(e-d)*(a-b)/(c-b)},init()}}(this))}).call(this);