function clamp(a,b,c){return b>a?b:a>c?c:a}function m_lerp(a,b,c){return b+a*(c-b)}function m_norm(a,b,c){return(a-b)/(c-b)}function m_map(a,b,c,d,e){return m_lerp(m_norm(a,b,c),d,e)}function Stage3d(){}function Cardinal(){}function CatmullRom(){}function QuadraticBezier(){}function PRNG(){}function random(a,b){return a+parseInt(PRNG.random()*b+.5)}function lerp(a,b,c){return b+a*(c-b)}function norm(a,b,c){return(a-b)/(c-b)}function map(a,b,c,d,e){return lerp(norm(a,b,c),d,e)}function angle(a,b){return Math.atan2(b.y-a.y,a.x-a.y)}function distance(a,b){var c=a.x-b.x,d=a.y-b.y,e=a.z-b.z;return Math.sqrt(c*c+d*d+e*e)}function rotate(a,b,c){var d=Point.angle(b,a)+c,e=Point.distance(b,a),f=new Point;return f.x=b.x+Math.cos(d)*e,f.y=b.y+Math.sin(d)*e,f}function reflect(a,b,c){var d=Utils.project(a,b,c,!1);return new Point(a.x+2*(d.x-a.x),a.y+2*(d.y-a.y))}function glide(a,b,c,d){var e=Utils.reflect(a,b,c),f=Point.angle(b,c);return Point.translate(e,cos(f)*Point.distance,sin(f)*d)}function project(a,b,c,d){var e=c.x-b.x,f=c.y-b.y;if(d&&0==e&&0==f)return b;var g=((a.x-b.x)*e+(a.y-b.y)*f)/(e*e+f*f);return d&&0>g?b:d&&g>1?c:new Point(b.x+g*e,b.y+g*f)}function getQueryVariable(a){for(var b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if(e[0]==a)return e[1]}return!1}function getHashVariable(a){for(var b=window.location.hash.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if(e[0]==a)return e[1]}return!1}function webgl_detect(a){if(window.WebGLRenderingContext){for(var b=document.createElement("canvas"),c=["webgl","experimental-webgl","moz-webgl","webkit-3d"],d=!1,e=0;4>e;e++)try{if(d=b.getContext(c[e]),d&&"function"==typeof d.getParameter)return a?{name:c[e],gl:d}:!0}catch(f){}return!1}return!1}function init(a){function b(){switch(requestAnimationFrame(b),o.position.y=n.container.position.y,u){case r.intro:Materials.GLOBE.uniforms.bumpAmount.value=.025,null!=n&&(n.globe.rotation.y-=.1*RAD);break;case r.workshop:Stage3d.locked=!1,n.globe.rotation.y=-Math.PI/2,m.update();break;case r.travel:n.globe.rotation.y=-Math.PI/2,p+=1e-4,p%=1,q=p+.035,q%=1,Stage3d.locked=!0,null!=m&&(c(n.curve,q,m),m.update());var a=Stage3d.camera.position,e=m.position,f=a.clone().sub(e).normalize().multiplyScalar(20).add(e),g=1.003*f.length();f.normalize().multiplyScalar(g),a.x+=.2*(f.x-a.x),a.y+=.2*(f.y-a.y),a.z+=.2*(f.z-a.z),d(a,f,Stage3d.camera)}Stage3d.render()}function c(a,b,c){var d=a.getPointAt(b),e=a.getPointAt((b+.01)%1),f=d.clone().normalize(),g=e.clone().normalize().sub(f).normalize();c.position.copy(d.multiplyScalar(.95+.02*Math.sin(.001*Date.now()))),c.matrix.lookAt(d,g.add(d),f),c.rotation.setFromRotationMatrix(c.matrix,c.rotation.order),c.rotateX(.005*Math.cos(.001*Date.now())),c.rotateY(-Math.PI/2+.015*Math.cos(.001*Date.now()))}function d(a,b,c){var d=a.clone().normalize(),e=b.clone().normalize().sub(d).normalize();c.position.copy(a),c.matrix.lookAt(a,e.add(a),d),c.rotation.setFromRotationMatrix(c.matrix,c.rotation.order),c.rotateX(-15*RAD)}function e(){new Materials;var a=parseInt(getHashVariable("model"))||Date.now();isNaN(a)&&(a=Date.now());var c=random(2,5),d=random(3,6),e=.01*random(1,2);m=new Plane3d(a),m.reset(c,d,e),m.update(),m.visible=!1,o=new Ring,n=o.content,requestAnimationFrame(b);var f=document.getElementById("title");TweenLite.to(f,.8,{delay:.5,css:{bottom:"80%"},ease:Expo.easeInOut}),new Hammer(f).on("tap",function(){window.open("http://barradeau.com/blog/?p=428","_blank"),Sound.mute()}),TweenLite.to(Stage3d.camera.position,1,{z:15,ease:Expo.easeInOut}),TweenLite.to(document.getElementById("intro"),.25,{opacity:0,onComplete:function(){document.body.removeChild(document.getElementById("intro"))}}),requestAnimationFrame(b)}function f(){clearTimeout(t),v.off("doubletap",f),v.on("swipe",k);var a=1.5,b=2.5;TweenLite.to(Stage3d.camera.position,2,{x:-15,y:5,z:20,ease:Expo.easeInOut}),b=.1,TweenLite.to(o.rotation,a,{x:-Math.PI/2,ease:Expo.easeOut}),b=2.5,TweenLite.to(n.container.scale,.5*a,{x:b,y:b,z:b,ease:Expo.easeOut,onComplete:g}),TweenLite.to(n.container.position,2,{delay:.5*a,y:-5,ease:Expo.easeOut})}function g(){var a=1;TweenLite.to(right,a,{opacity:1,ease:Expo.easeOut}),TweenLite.to(left,a,{opacity:1,ease:Expo.easeOut}),TweenLite.to(down,a,{opacity:1,ease:Expo.easeOut}),new Hammer(left).on("tap",k),new Hammer(right).on("tap",k),new Hammer(down).on("tap",h),u=r.workshop,m.visible=!0,m.position.y=100,m.update(),TweenLite.to(m.position,a,{y:0,ease:Expo.easeOut}),TweenLite.to(Materials.GLOBE.uniforms.bumpAmount,1,{value:.05,ease:Expo.easeInOut,onComplete:function(){n.init()}})}function h(){u==r.workshop?j():i()}function i(){u=r.workshop,TweenLite.to(Stage3d.camera.position,2,{x:-15,y:5,z:20,ease:Expo.easeInOut}),m.visible=!0,m.position.x=0,m.position.y=100,m.position.z=0,m.rotation.set(0,0,0),m.update(),TweenLite.to(m.position,x,{y:0,ease:Expo.easeOut}),Stage3d.locked=!1,s=2.5,TweenLite.to(n.container.scale,0,{x:s,y:s,z:s,ease:Expo.easeOut}),TweenLite.to(n.container.position,2,{delay:.5*x,y:-5,ease:Expo.easeOut}),TweenLite.to(Materials.GLOBE.uniforms.bumpAmount,1,{value:.005,ease:Expo.easeInOut}),TweenLite.to(right,x,{opacity:1,ease:Expo.easeOut}),TweenLite.to(left,x,{opacity:1,ease:Expo.easeOut})}function j(){TweenLite.to(Materials.GLOBE.uniforms.bumpAmount,1,{value:.05,ease:Expo.easeInOut}),p=0,q=p+.035,u=r.travel,TweenLite.to(right,x,{opacity:0,ease:Expo.easeOut}),TweenLite.to(left,x,{opacity:0,ease:Expo.easeOut}),Stage3d.locked=!0,c(n.curve,q,m),m.update();var a=n.worldScale;TweenLite.to(n.container.scale,4,{x:a,y:a,z:a})}function k(a){if(u==r.workshop&&(console.log("resetPlane",a),null!=m)){m.seed++,PRNG.initialize_generator(m.seed);var b=random(2,5),c=random(3,6),d=.01*random(1,2);m.reset(b,c,d)}}if(!a){var l=document.getElementById("title");return l.innerHTML=l.innerHTML+"<br>HOP",TweenLite.to(l,.8,{delay:1,css:{left:"-80%"},onComplete:function(){var a=document.getElementById("intro");a.innerHTML='<iframe src="//player.vimeo.com/video/114498077?byline=0&amp;portrait=0" width="100%" height="100%" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>'},ease:Expo.easeOut}),void new Hammer(l).on("tap",function(){window.open("http://barradeau.com/blog/?p=428","_blank")})}Stage3d.init();var m,n,o,p=0,q=0,r={};r.intro=0,r.workshop=1,r.travel=2;var t,u=r.intro;t=setTimeout(f,1e4);var v=new Hammer(Stage3d.domElement);v.on("doubletap",f),window.onresize=function(){Stage3d.resize()},Stage3d.camera.position.set(0,0,25),Stage3d.renderer.shadowMapType=THREE.PCFSoftShadowMap,Stage3d.renderer.shadowMapEnabled=!0,Stage3d.renderer.shadowMapSoft=!0;var w;w=new THREE.DirectionalLight(14674943,1.2),w.position.set(3,4,-2.5),w.position.multiplyScalar(103.3),w.castShadow=!0,w.shadowMapWidth=2048,w.shadowMapHeight=2048;var x=4;w.shadowCameraLeft=-x,w.shadowCameraRight=x,w.shadowCameraTop=x,w.shadowCameraBottom=-x,w.shadowCameraFar=1e4,w.shadowDarkness=.2,Stage3d.scene.add(w);var y=new ShaderLoader;y.loadShaders("./assets/glsl/",e)}var Ring=function(){THREE.Object3D.call(this);{var a=new THREE.Vector3(0,0,.5),b=new THREE.Vector3(0,0,-.5);new THREE.SplineCurve3([a,b])}this.ring=new THREE.Mesh(new THREE.TorusGeometry(2.5,.35,16,64),Materials.RING),this.ring.scale.set(1,1,.32),this.add(this.ring),this.content=new World(this),this.content.container.scale.set(2.35,2.35,.35),Stage3d.add(this.content.container),this.portrait=new THREE.Mesh(new THREE.SphereGeometry(2.5,64,32,0,Math.PI),Materials.PORTRAIT),this.portrait.scale.set(1,1,.21),this.add(this.portrait),this.ring.castShadow=this.content.castShadow=this.portrait.castShadow=!0;new THREE.TorusGeometry(2.75,.1,3,32,Math.PI);Stage3d.add(this)};Ring.prototype=Object.create(THREE.Object3D.prototype);var Materials=function(){new Skybox;var a=new THREE.Texture(CanvasNoise(256,256,64,128,!1,!1));a.wrapS=a.wrapT=THREE.RepeatWrapping,a.needsUpdate=!0;var b=THREE.ImageUtils.loadTexture("img/earth_night.jpg",null,function(){b.needsUpdate=!0}),c=THREE.ImageUtils.loadTexture("img/heightmap_1024.png",null,function(){c.needsUpdate=!0}),d=THREE.ImageUtils.loadTexture("img/gradient.jpg",null,function(){d.needsUpdate=!0}),e=THREE.ImageUtils.loadTexture("img/rubber.jpg",null,function(){e.needsUpdate=!0}),f=THREE.ImageUtils.loadTexture("img/copper_1.png",null,function(){f.needsUpdate=!0}),g=THREE.ImageUtils.loadTexture("img/brass.png",null,function(){g.needsUpdate=!0}),h=THREE.ImageUtils.loadTexture("img/steel.jpg",null,function(){h.needsUpdate=!0}),i=THREE.ImageUtils.loadTexture("img/wing.png",null,function(){i.needsUpdate=!0}),j=THREE.ImageUtils.loadTexture("img/wood.jpg",null,function(){j.needsUpdate=!0}),k=THREE.ImageUtils.loadTexture("img/tr_harriet.png",null,function(){k.wrapS=l.wrapT=THREE.RepeatWrapping,k.needsUpdate=!0}),l=THREE.ImageUtils.loadTexture("img/nr_harriet.png",null,function(){l.wrapS=l.wrapT=THREE.RepeatWrapping,l.needsUpdate=!0});Materials.SEM=new THREE.ShaderMaterial({uniforms:{environment:{type:"t",value:f},texture:{type:"t",value:a},bump:{type:"t",value:a},bumpAmount:{type:"f",value:0},time:{type:"f",value:0},type:{type:"i",value:1},grain:{type:"f",value:.4},alpha:{type:"f",value:1}},vertexShader:ShaderLoader.get("sem_vs"),fragmentShader:ShaderLoader.get("sem_fs"),shading:THREE.SmoothShading,ambient:8421504,side:THREE.DoubleSide,transparent:!0}),Materials.SEM.uniforms.environment.value.wrapS=Materials.SEM.uniforms.environment.value.wrapT=Materials.SEM.uniforms.texture.value.wrapS=Materials.SEM.uniforms.texture.value.wrapT=Materials.SEM.uniforms.bump.value.wrapS=Materials.SEM.uniforms.bump.value.wrapT=THREE.ClampToEdgeWrapping,Materials.WOOD=Materials.SEM.clone(),Materials.WOOD.uniforms.environment.value=e,Materials.WOOD.uniforms.texture.value=j,Materials.WOOD.uniforms.alpha.value=1,Materials.WOOD.uniforms.type.value=1,Materials.WING=Materials.SEM.clone(),Materials.WING.uniforms.environment.value=d,Materials.WING.uniforms.texture.value=j,Materials.WING.uniforms.alpha.value=.85,Materials.WING.uniforms.type.value=3,Materials.WING.uniforms.grain.value=.5,Materials.WING.side=THREE.FrontSide,Materials.WIRE=new THREE.MeshBasicMaterial({wireframe:!0,color:8421504}),Materials.MONUMENT=new THREE.MeshLambertMaterial({color:15658734,side:THREE.DoubleSide}),Materials.GLOBE=new THREE.MeshPhongMaterial({color:15658734,shininess:20,envMap:Skybox.material,bumpMap:c,bumpScale:.25}),Materials.GLOBE=Materials.SEM.clone(),Materials.GLOBE.uniforms.grain.value=.5,Materials.GLOBE.uniforms.type.value=3,Materials.GLOBE.uniforms.environment.value=d,Materials.GLOBE.uniforms.texture.value=b,Materials.GLOBE.uniforms.bump.value=c,Materials.GLOBE.uniforms.bumpAmount.value=.05,Materials.MONUMENT=Materials.GLOBE,Materials.NOISE=a,Materials.SECTION=new THREE.MeshBasicMaterial({map:a}),Materials.RING=Materials.SEM.clone(),Materials.RING.uniforms.environment.value=g,Materials.RING.uniforms.texture.value=a,Materials.RING.uniforms.bump.value=a,Materials.RING.uniforms.bumpAmount.value=.005,Materials.RING.uniforms.type.value=4,Materials.RING.uniforms.grain.value=.5,Materials.PORTRAIT=Materials.SEM.clone(),Materials.PORTRAIT.side=THREE.FrontSide,Materials.PORTRAIT.uniforms.environment.value=d,Materials.PORTRAIT.uniforms.texture.value=k,Materials.PORTRAIT.uniforms.bump.value=l,Materials.PORTRAIT.uniforms.bumpAmount.value=.01,Materials.PORTRAIT.uniforms.type.value=3,Materials.PORTRAIT.uniforms.grain.value=.65,Materials.plane=[]},ShaderLoader=function(){ShaderLoader.shaders={sem_vs:"",sem_fs:""},ShaderLoader.get=function(a){return ShaderLoader.shaders[a]}};ShaderLoader.prototype={loadShaders:function(a,b){this.baseUrl=a||"./",this.callback=b,this.batchLoad(this,"onShadersReady")},batchLoad:function(a,b){function c(c,e){return function(){ShaderLoader.shaders[c]=e.responseText,--d<=0&&a[b]()}}var d=0;for(var e in ShaderLoader.shaders){d++;var f=new XMLHttpRequest;f.onload=c(e,f),f.open("get",a.baseUrl+e+".glsl",!0),f.send()}},onShadersReady:function(){null!=this.callback&&this.callback()}};var i=0,T={};T.ELEMENT=i++,T.ENGINE=i++,T.EXTRA_ENGINE=i++,T.COCKPIT=i++,T.DIRECTION=i++,T.WING=i++,T.WHEEL=i++,T.BLOCK=i++,T.STICK=i++,T.CABLE=i++,T.EMPTY=i++,T.MONUMENT=i++;var Generator=function(){this.config=[],this.minY=0};Generator.prototype={generate:function(a,b){b=b||3,this.config=[this.getParamObject("c",T.COCKPIT)];var c;for(c=0;b>c;c++){var d=(PRNG.random(),this.getParamObject("b_"+c,PRNG.random()>.75?T.BLOCK:T.EMPTY));d.pos.y=random(-1,2),PRNG.random()>.5?this.config.unshift(d):this.config.push(d)}this.config.unshift(this.getParamObject("e",T.ENGINE)),this.config.push(this.getParamObject("d",T.DIRECTION));var e=0,f=0;for(c=0;c<this.config.length-1;c++){var g=(this.config[c],this.config[c+1]);e+=1,f+=g.pos.y,g.pos.x=e,g.pos.y=f}f-=1,a.offset=new THREE.Vector3(-e/2,-f/2,0)},build:function(a,b,c){var d=this;if(Plane3d.container.children.reverse(),Plane3d.container.children.length>0){return Plane3d.container.children.forEach(function(a,b,c){TweenLite.to(a,0,{delay:.5*(b/c.length),onComplete:function(){Plane3d.container.remove(a)}})}),void TweenLite.to(a.rotation,.5,{y:2*-Math.PI+a.rotation.y,onComplete:function(){d.build(a,b,c)}})}a.elements=[];var e=new Point(1e11,1e11,1e11),f=new Point(1e-9,1e-9,1e-9);this.config.forEach(function(b){var c=new Part(b.pos,b.type);a.elements.push(c),b.pos.x<e.x&&(e.x=b.pos.x),b.pos.y<e.y&&(e.y=b.pos.y),b.pos.x>f.x&&(f.x=b.pos.x),b.pos.y>f.y&&(f.y=b.pos.y)});var g=[T.ENGINE,T.DIRECTION,T.COCKPIT];a.elements.forEach(function(b,c,f){if(b.type==T.COCKPIT&&d.appendWheels(a,b,1),-1!=g.indexOf(b.type)&&d.wings(a,b,e.y),b.type==T.COCKPIT&&f[c-1].type==T.EMPTY&&PRNG.random()>0){var h=b.position.clone();h.x-=.5,h.y-=.5;var i=new Part(h,T.EXTRA_ENGINE);new Engine(i),a.elements.push(i)}}),Generator.minY=this.minY,this.sticks(a,.5,c),this.bind(a,.5),a.elements.forEach(function(a,b,c){Plane3d.container.remove(a),TweenLite.to(a,b/c.length*.5,{onComplete:function(){Plane3d.container.add(a)}})}),TweenLite.to(Plane3d.container.position,.5,{x:a.offset.x,y:a.offset.y})},appendWheels:function(a,b,c){new Wheel(b,c);b.hasWheels=!0},wings:function(a,b){new Wing(b,a,0)},sticks:function(a,b,c){for(var d=[],e=[],f=([T.BLOCK,T.EXTRA_ENGINE,T.ENGINE,T.DIRECTION,T.COCKPIT],0);f<a.elements.length-1;f++){var g=a.elements[f];if(g.type!=T.EMPTY){for(var h=a.elements[f+1];!(h.type!=T.EMPTY&&h.type!=T.STICK||(f++,f>=a.elements.length-1)||(h=a.elements[f+1],h.type==T.STICK)););g.type!=T.STICK&&h.type!=T.STICK&&(a.elements.push(new Stick(g,h,"front","left",c)),a.elements.push(new Stick(g,h,"back","left",c)),a.elements.push(new Stick(g,h,"front","center",c)),a.elements.push(new Stick(g,h,"back","center",c)),d=d.concat(e))}}},bind:function(a,b){for(var c=[T.ENGINE,T.DIRECTION,T.COCKPIT],d=0;d<a.elements.length-1;d++){var e=a.elements[d];if(-1!=c.indexOf(e.type)){for(var f=a.elements[d+1];-1==c.indexOf(f.type)&&(d++,!(d>=a.elements.length-1));)f=a.elements[d+1];null!=f&&-1!=c.indexOf(f.type)&&e.type!=T.STICK&&f.type!=T.STICK&&(PRNG.random()>b&&a.elements.push(new Cable(e,f,"front","right")),PRNG.random()>b&&a.elements.push(new Cable(e,f,"back","right")),PRNG.random()>b&&a.elements.push(new Cable(e,f,"front","center")),PRNG.random()>b&&a.elements.push(new Cable(e,f,"back","center")),PRNG.random()>b&&a.elements.push(new Cable(e,f,"front","left")),PRNG.random()>b&&a.elements.push(new Cable(e,f,"back","left")))}}},getParamObject:function(a,b){return{id:a,type:b,pos:new Point}}};var GeometryLoader=function(a,b,c,d){null!=a&&(GeometryLoader.urls=a,GeometryLoader.scope=b,GeometryLoader.onMeshLoaded=c,GeometryLoader.onLoadCompleteCallback=d,GeometryLoader.loadNext())};GeometryLoader.geoms=[],GeometryLoader.loadNext=function(){GeometryLoader.loader=GeometryLoader.loader||new THREE.JSONLoader,GeometryLoader.loader.load(GeometryLoader.urls[0].url,function(a){var b=GeometryLoader.urls[0];null!=GeometryLoader.scope&&GeometryLoader.scope[GeometryLoader.onMeshLoaded](b,a),GeometryLoader.geoms.push({id:b.id||"mesh_"+Date.now().toString(),type:b.type||T.EMPTY,geom:a}),GeometryLoader.urls.shift(),GeometryLoader.urls.length>0?GeometryLoader.loadNext():null!=GeometryLoader.scope&&GeometryLoader.scope[GeometryLoader.onLoadCompleteCallback]()})},GeometryLoader.getGeometriesByType=function(a){var b=[];return GeometryLoader.geoms.forEach(function(c){c.type==a&&b.push(c)}),b},GeometryLoader.getGeometryById=function(a,b){var c=[];return a.forEach(function(a){-1!=a.id.lastIndexOf(b)&&c.push(a)}),c[parseInt(Math.random()*c.length)].geom},GeometryLoader.getElement=function(a){{var b;GeometryLoader.getGeometriesByType(a.type)}switch(a.type){case T.ENGINE:new Engine(a);break;case T.WHEEL:break;case T.BLOCK:b=new THREE.Mesh(Part.CUBE,Part.MAT),b.position.set(-.25,0,0),b.scale.set(.5,.01,1),b.castShadow=!0;var c=new Aileron;c.rotation.x=Math.PI/2,c.position.x=-.5,c.position.z=.5,a.add(c);var d=c.clone();d.rotation.x=-Math.PI/2,d.position.x=-.5,d.position.z=-.5,a.add(d),c.scale.set(1,2,1),d.scale.set(1,2,1),a.add(b);break;case T.DIRECTION:new Direction(a);break;case T.COCKPIT:new Cockpit(a)}return b};var MathUtils=function(){};MathUtils.lonLatToVector3=function(a,b,c){return c=c||new THREE.Vector3,b=Math.PI/2-b,c.set(Math.sin(b)*Math.sin(a),Math.cos(b),Math.sin(b)*Math.cos(a)),c},MathUtils.vector3toLonLat=function(a){a.normalize();var b=-Math.atan2(-a.z,-a.x)-Math.PI/2;b<-Math.PI&&(b+=2*Math.PI);var c=new THREE.Vector3(a.x,0,a.z);c.normalize();var d=Math.acos(c.dot(a));return a.y<0&&(d*=-1),[b,d]},MathUtils.polygonContains=function(a,b,c){for(var d=0,e=!1,f=0;f<a.length;f++){d=(f+1)%a.length;var g=a[f].x,h=a[f].y,i=a[d].x,j=a[d].y;(c>h&&j>=c||c>j&&h>=c)&&b>g+(c-h)/(i-g)*(i-g)&&(e=!e)}return e},MathUtils.intersectSphere=function(a,b,c,d,e,f,g,h,i,j){var k=d-a,l=e-b,m=f-c,n=k*k+l*l+m*m,o=2*(a*k+b*l+c*m-k*g-l*h-m*i),p=a*a-2*a*g+g*g+b*b-2*b*h+h*h+c*c-2*c*i+i*i-j*j,q=o*o-4*n*p;if(q>=0){var r=(-o-Math.sqrt(q))/(2*n),s=(-o+Math.sqrt(q))/(2*n),t=s>r?r:s;return new THREE.Vector3(a+t*(d-a),b+t*(e-b),c+t*(f-c))}return null};var Plane3d=function(a){THREE.Object3D.call(this),this.seed=a||0,this.elements=[],this.generator=new Generator,this.container=Plane3d.container=new THREE.Object3D,this.add(Plane3d.container),Plane3d.castShadow=!0,Stage3d.scene.add(this),this.reset=function(a,b,c){null==this.seed&&(this.seed=Date.now()),PRNG.initialize_generator(this.seed),window.location.hash="model="+this.seed,this.generator.generate(this,a),this.generator.build(this,b||.5,c||1)},this.update=function(a,b){this.elements.forEach(function(a){a.animate(b)})}};Plane3d.prototype=Object.create(THREE.Object3D.prototype),Stage3d.init=function(){var a=window.innerWidth,b=window.innerHeight;this.camera=new THREE.PerspectiveCamera(40,a/b,.5,1e7),this.camera.position.z=100,this.scene=new THREE.Scene,this.renderer=new THREE.WebGLRenderer({alpha:!1,precision:"highp",antialias:!0}),this.domElement=this.renderer.domElement,document.body.appendChild(this.domElement),this.renderer.setSize(a,b),this.control=new THREE.OrbitControls(this.camera,document.body),this.control.minPolarAngle=Math.PI/4,this.control.maxPolarAngle=Math.PI/2,this.locked=!1,this.control.minDistance=10,this.control.maxDistance=25},Stage3d.add=function(a){this.scene.add(a)},Stage3d.remove=function(a){this.scene.remove(a)},Stage3d.initComposer=function(){var a=window.innerWidth,b=window.innerHeight;this.composer=new Composer(a,b,this.renderer,this.scene,this.camera)},Stage3d.render=function(){this.locked||(this.control.update(),this.camera.lookAt(this.scene.position)),this.renderer.render(this.scene,this.camera)},Stage3d.resize=function(){var a=window.innerWidth,b=window.innerHeight;this.camera.aspect=a/b,this.camera.updateProjectionMatrix(),this.renderer.setSize(a,b)};var Aileron=function(){{var a=1,b=1,c=Math.PI/4+PRNG.random()*Math.PI/4,d=random(3,5),e=.75+.5*PRNG.random(),f=[],g=[],h=new THREE.Vector3(0,0);new THREE.Vector3(a,0),new THREE.Vector3(0,b)}f.push(h),g.push(h.clone());for(var i,j,k=c/d/2,l=0,m=0;c>=m;m+=k)l++%2==0?(i=new THREE.Vector3(h.x+Math.cos(m)*a,h.y+Math.sin(m)*b),f.push(i),1>e?(j=new THREE.Vector3(h.x+Math.cos(m)*a*(2-e),h.y+Math.sin(m)*b*(2-e)),g.push(h.clone(),j)):g.push(h.clone(),i.clone())):(i=new THREE.Vector3(h.x+Math.cos(m)*a*e,h.y+Math.sin(m)*b*e),f.push(i),e>1&&g.push(h.clone(),i.clone()));f.push(h.clone()),f=CatmullRom.compute(f,.1),f.reverse();var n=new Loft(g,Section.createRegularSection(.01,3),Materials.SEM);n.position.z+=.005,n.castShadow=!0,this.structure=n;var o=new Extrude(new THREE.Vector3(0,0,1),f,.01,1,Materials.WING);o.castShadow=!0,this.sail=o;var p=new THREE.Object3D;return p.add(n),p.add(o),p};Aileron.prototype={clone:function(){var a=new THREE.Mesh(this.structure.geometry,Materials.SEM),b=new THREE.Mesh(this.sail.geometry,Materials.WING),c=new THREE.Object3D;return c.add(a),c.add(b),c}};var Cable=function(a,b,c,d,e){THREE.Object3D.call(this),this.side=c||"front",d=d||["left","center","right"][parseInt(3*Math.random())],this.p0=a.pivots[this.side][d],this.p1=b.pivots[this.side][d],this.cp0=this.p0.clone(),this.cp0.y-=.5,this.cp0.z+="front"==this.side?.1:-.1,this.mid=this.p0.clone().add(this.p1).multiplyScalar(.5),this.mid.y=Math.min(this.p0.y,Math.min(this.p1.y,-1)),this.cp1=this.p1.clone(),this.cp1.y-=.5,this.cp1.z+="front"==this.side?.1:-.1,this.size=e||.01;var f=Section.createRegularSection(this.size,3);this.precision=.1,this.path=QuadraticBezier.compute([this.p0,this.cp0,this.mid,this.cp1,this.p1],this.precision),this.mesh=new Loft(this.path,f,Materials.SEM),this.mesh.castShadow=!0,this.add(this.mesh),Plane3d.container.add(this),this.type=T.CABLE};Cable.prototype=Object.create(THREE.Object3D.prototype),Cable.prototype.animate=function(){this.cp0.copy(this.p0),this.cp0.y-=.5,this.cp0.z+="front"==this.side?.1:-.1,this.mid.copy(this.p0).add(this.p1).multiplyScalar(.5),this.mid.y=Math.min(this.p0.y,Math.min(this.p1.y,-1)),this.cp1.copy(this.p1),this.cp1.y-=.5,this.cp1.z+="front"==this.side?.1:-.1,this.path=QuadraticBezier.compute([this.p0,this.cp0,this.mid,this.cp1,this.p1],this.precision),this.mesh.update(this.path)};var Cockpit=function(a){for(var b,c,d,e,f,g,h,i,j,k,l=.2+.15*Math.random(),m=.35+.1*Math.random(),n=new THREE.Geometry,o=[],p=[],q=[],r=15,s=15,t=0,u=0,v=1;s>v;v++){var w=[];for(b=1;r>b;b++){t=b/r*Math.PI-Math.PI/2,u=v/s*Math.PI-Math.PI/2,j=Math.tan(t),k=Math.tan(u);var x=new THREE.Vector3(-j/r*2,-k/s*4,0);w.push(x),p.push(x),q.push(new THREE.Vector2(j,k))}o.push(w)}var y=1/Math.tan(Math.PI/2*(r-2)/r);for(q.forEach(function(a){a.x=.5+a.x*y,a.y=.5+a.y*y}),n.vertices=p,n.uvs=q,b=0;b<o.length-1;b++)for(v=0;v<o[0].length-1;v++)f=p.indexOf(o[b][v]),g=p.indexOf(o[b+1][v]),h=p.indexOf(o[b][v+1]),i=p.indexOf(o[b+1][v+1]),n.faces.push(new THREE.Face3(f,i,g)),n.faces.push(new THREE.Face3(f,h,i));for(b=0;b<n.vertices.length;b++){var z=n.vertices[b];Math.abs(z.x)<l&&Math.abs(z.y)<m&&(c=Math.atan2(z.y,z.x),z.x=Math.cos(c)*l,z.y=Math.sin(c)*m,z.inside=1)}for(b=0;b<n.faces.length;b++){var A=n.faces[b];if(A.valid=!0,f=A.a,g=A.b,h=A.c,c=n.vertices[f].inside,d=n.vertices[g].inside,e=n.vertices[h].inside,!(isNaN(c)&&isNaN(d)&&isNaN(e))){var B=0;if(null!=c&&B++,null!=d&&B++,null!=e&&B++,!(3>B)){var C=(n.vertices[f].x+n.vertices[g].x+n.vertices[h].x)/3,D=(n.vertices[f].y+n.vertices[g].y+n.vertices[h].y)/3;if(Math.abs(C)<l&&Math.abs(D)<m){var E=new THREE.Vector3(C,D);c=Math.atan2(D,C);var F=Math.cos(c)*l,G=Math.sin(c)*m,H=new THREE.Vector3(F,G);E.length()<H.length()&&(A.valid=!1)}}}}var I=[];n.faces.forEach(function(a){a.valid&&(I.push(a),f=a.a,g=a.b,h=a.c,n.faceVertexUvs[0].push([q[f],q[i],q[g]]),n.faceVertexUvs[0].push([q[f],q[h],q[i]]))});var J=[],K=1e11,L=1e11;for(b=0;b<n.vertices.length;b++)z=n.vertices[b],c=map(z.y,-2,2,0,2*Math.PI),z.y=.5*-Math.cos(c)-.25,z.z=.5*Math.sin(c),K=z.x<K?z.x:K,L=z.y<L?z.y:L,b%r==0&&J.push(new THREE.Vector3(z.z,z.y));if(n.verticesNeedUpdate=!0,n.uvsNeedUpdate=!0,n.faces=I,n.computeFaceNormals(),n.computeVertexNormals(),null!=a){var M=new Lathe(new THREE.Vector3(0,1,0),J,16,Materials.SEM,Math.PI);M.rotation.y=Math.PI/2,M.position.x=-K,M.castShadow=!0,a.add(M);var N=new Section(J,Materials.RING);N.rotation.y=Math.PI/2,N.position.x=-.5,N.castShadow=!0,a.add(N);var O=new THREE.Mesh(Part.CUBE,Materials.SEM);O.scale.set(2*K,.01,1),O.position.set(0,L,0),O.castShadow=!0,a.add(O);var P=new THREE.Mesh(n,Materials.SEM);P.castShadow=!0,a.add(P)}this.faces=n.faces,this.frame=n.vertices},Direction=function(a){var b=new Aileron;b.scale.multiplyScalar(1+2*PRNG.random()),a.sail=b,a.add(b);var c=new THREE.Mesh(Part.CUBE,Part.MAT);c.position.set(0,0,0),c.scale.set(.05,.05,1),c.castShadow=!0,a.add(c),a.pivots={front:{left:a.position,center:a.position,right:a.position},back:{left:a.position,center:a.position,right:a.position}}},Engine=function(a){var b=.1+.1*PRNG.random(),c=b+.25*PRNG.random(),d=b+c,e=.5,f=.5*PRNG.random(),g=e+f,h=[];h.push(new THREE.Vector2(0,0),new THREE.Vector2(0,b),new THREE.Vector2(e,c),new THREE.Vector2(g,c),new THREE.Vector2(g,b),new THREE.Vector2(e,b),new THREE.Vector2(e,0));var i=32,j=new Section(CatmullRom.compute(h,.1,!1)),k=new Lathe(new THREE.Vector3(1,0,0),j,i,Materials.RING);k.castShadow=!0,k.position.x=.5*g,k.rotation.y=Math.PI,a.add(k);var l=Section.createRegularSection(.1*d,3);Section.offset(l,"x",g),Section.offset(l,"y",c);var m=new Lathe(new THREE.Vector3(-1,0,0),l,i,Materials.SEM);k.add(m);var n=new THREE.Mesh(Part.CUBE,Materials.SEM);n.scale.set(.5,.01,1),n.position.x+=.225,n.castShadow=!0,a.add(n);new Propeller(a,d);a.propeller.position.x=.65*-g},Part=function(a,b){THREE.Object3D.call(this),a=a||new THREE.Vector3,this.position.copy(a),this.origin=a.clone(),this.castShadow=!0,this.height=1,this.width=1,this.depth=1,this.tl=new THREE.Vector3(-.5,.5),this.tr=new THREE.Vector3(.5,.5),this.bl=new THREE.Vector3(-.5,-.5),this.br=new THREE.Vector3(.5,-.5),this.pivots={front:{left:new THREE.Vector3(a.x-.4,a.y,a.z+.5),center:new THREE.Vector3(a.x,a.y,a.z+.5),right:new THREE.Vector3(a.x+.4,a.y,a.z+.5)},back:{left:new THREE.Vector3(a.x-.4,a.y,a.z-.5),center:new THREE.Vector3(a.x,a.y,a.z-.5),right:new THREE.Vector3(a.x+.4,a.y,a.z-.5)}},this.type=b||0,Part.CYLINDER=new THREE.CylinderGeometry(.5,.5,1,16,1),Part.CUBE=new THREE.BoxGeometry(1,1,1),Part.MAT=Materials.SEM,Part.WINGS=new THREE.MeshLambertMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,wireframe:!1}),Part.MAT_LINE=new THREE.LineBasicMaterial({color:3158064}),null!=Plane3d.container&&Plane3d.container.add(this),this.hasWings=!1,this.hasWheels=!1,this.propeller=null,this.sail=null,this.type!=T.EMPTY&&GeometryLoader.getElement(this),this.init()};Part.prototype=Object.create(THREE.Object3D.prototype);var quaternion=new THREE.Quaternion;Part.prototype.init=function(){var a=2*Math.PI,b=Math.PI/180,c=.5*b;this.sailsAngle=PRNG.random()*Math.PI*2,this.radius=.01+.05*PRNG.random(),this.angle=new THREE.Euler(PRNG.random()*a,PRNG.random()*a,PRNG.random()*a),this.speed=PRNG.random()*c},Part.prototype.animate=function(){this.angle.x+=this.speed,this.angle.y+=this.speed,this.angle.z+=this.speed,this.position.set(1,0,0),quaternion.setFromEuler(this.angle),this.position.applyQuaternion(quaternion),this.position.normalize(),this.position.multiplyScalar(this.radius).add(this.origin);var a=this.position.x,b=this.position.y,c=this.position.z;if(this.tl.x=a-.5,this.tl.y=b+.5,this.tr.x=a+.5,this.tr.y=b+.5,this.bl.x=a-.5,this.bl.y=b-.5,this.br.x=a+.5,this.br.y=b-.5,this.type!=T.DIRECTION){var d;this.pivots.front.left.x=a-.4,this.pivots.front.right.x=a+.4,this.pivots.back.left.x=a-.4,this.pivots.back.right.x=a+.4;for(d in this.pivots.front)this.pivots.front[d].y=b,this.pivots.front[d].z=c+.5;for(d in this.pivots.back)this.pivots.back[d].y=b,this.pivots.back[d].z=c-.5}else this.pivots={front:{left:this.position,center:this.position,right:this.position},back:{left:this.position,center:this.position,right:this.position}};(this.type==T.ENGINE||this.type==T.EXTRA_ENGINE)&&null!=this.propeller&&(this.propeller.rotation.z+=7*RAD),this.type==T.BLOCK&&(this.rotation.z=5*Math.sin(this.sailsAngle+.001*Date.now())*RAD),this.type==T.DIRECTION&&null!=this.sail&&(this.sail.rotation.y=5*Math.sin(.001*Date.now()+this.sailsAngle)*RAD)},Part.prototype.dispose=function(){delete this};var Propeller=function(a,b){var c=new THREE.Object3D,d=[new THREE.Vector3(0,0,0),new THREE.Vector3(-.5,.5*b,0),new THREE.Vector3(-.25,1.5*b,0),new THREE.Vector3(.35,b,0),new THREE.Vector3(.25,.5*b,0),new THREE.Vector3(.15,0,0),new THREE.Vector3(0,0,0)],e=.1*PRNG.random()+.1,f=1e11;d.forEach(function(a){a.x*=e,f=f>a.x?a.x:f});var g=CatmullRom.compute(d,.2);g.forEach(function(){});var h=new Extrude(new THREE.Vector3(0,0,1),g,.05,2,Materials.WOOD);try{Caps.getFaces(h.geometry,0,g.length)}catch(i){return}for(var j=random(2,6),k=2*Math.PI/j,l=0;j>l;l++){var m=h.clone();m.rotation.z=l*k,m.castShadow=!0,c.add(m)}c.rotation.y=Math.PI/2;var n=new THREE.CylinderGeometry(.3*b,.3*b,.05,16),o=new THREE.Mesh(n,Materials.WOOD);o.rotation.x=Math.PI/2,c.add(o),n=new THREE.CylinderGeometry(.1*b,.1*b,.65,16),o=new THREE.Mesh(n,Materials.SEM),o.rotation.x=Math.PI/2,o.position.z=.25,c.add(o),a.add(c),a.propeller=c},Stick=function(a,b,c,d,e){THREE.Object3D.call(this),c=c||"front",d=d||["left","center","right"][parseInt(3*Math.random())],this.p0=a.pivots[c][d],this.p1=b.pivots[c][d],this.size=e||.01,this.mesh=new THREE.Mesh(Part.CUBE,Part.MAT),this.mesh.castShadow=!0,this.add(this.mesh),Plane3d.container.add(this),this.type=T.STICK};Stick.prototype=Object.create(THREE.Object3D.prototype),Stick.prototype.animate=function(){var a=distance(this.p0,this.p1);this.mesh.position.x=.5*(this.p0.x+this.p1.x),this.mesh.position.y=.5*(this.p0.y+this.p1.y),this.mesh.position.z=this.p0.z,this.mesh.scale.set(this.size,this.size,a),this.mesh.lookAt(this.p0)};var Wheel=function(a,b){var c=.15+.15*PRNG.random(),d=new THREE.Object3D,e=new THREE.TorusGeometry(c,.01+.05*PRNG.random(),6,64),f=new THREE.Mesh(e,Materials.WOOD);d.add(f);var g=new THREE.Mesh(e,Materials.WOOD);d.add(g),f.position.y=-.25,g.position.y=-.25,f.position.z=.5,g.position.z=-.5;var h=new THREE.Mesh(Part.CUBE,Materials.SEM);h.scale.set(.05,.05,1),h.rotation.x=-Math.PI/6,h.castShadow=!0,d.add(h);var h=new THREE.Mesh(Part.CUBE,Materials.SEM);h.scale.set(.05,.05,1),h.rotation.x=Math.PI/6,h.castShadow=!0,d.add(h);var h=new THREE.Mesh(Part.CUBE,Materials.SEM);h.scale.set(.05,.5,.05),h.castShadow=!0,h.position.z-=.5,d.add(h);var h=new THREE.Mesh(Part.CUBE,Materials.SEM);h.scale.set(.05,.5,.05),h.castShadow=!0,h.position.z+=.5,d.add(h),b=b||1,d.position.y-=.5,d.scale.set(b,b,b),a.add(d)},Wing=function(a){var b=[],c=.05*Math.random(),d=new THREE.Vector3(-.4+.8*PRNG.random(),.2*(PRNG.random()-.5));b.push(new THREE.Vector3(-.5,0),new THREE.Vector3(d.x,d.y-c),new THREE.Vector3(.5,0),new THREE.Vector3(d.x,d.y+c)),b.reverse(),b=CatmullRom.compute(b,.1,!0);for(var e,f,g=Section.createRegularSection(.005,3),h=new THREE.Object3D,i=2*random(1,3)+1,j=random(1,3),k=Math.max(0,random(0,-j)),l=.75+.5*PRNG.random(),m=new Loft(b,g,Materials.SEM),n=new Extrude(new THREE.Vector3(0,0,1),b,i,1,Materials.WING),o=k;j+k>o;o++)if(0==o){for(f=0;i>=f;f++)e=new THREE.Mesh(m.geometry,Materials.SEM),e.position.y=o*l,e.position.z=-i/2+f,e.castShadow=!0,h.add(e);e=new THREE.Mesh(n.geometry,Materials.WING),e.position.y=o*l,e.position.z=-i/2,e.castShadow=!0,e.scale.set(1,1,(i-1)/i/2),h.add(e),e=new THREE.Mesh(n.geometry,Materials.WING),e.position.y=o*l,e.position.z=.5,e.castShadow=!0,e.scale.set(1,1,(i-1)/i/2),h.add(e)}else{for(f=0;i>=f;f++)e=new THREE.Mesh(m.geometry,Materials.SEM),e.position.y=o*l,e.position.z=-i/2+f,e.castShadow=!0,h.add(e);e=new THREE.Mesh(n.geometry,Materials.WING),e.position.y=o*l,e.position.z=-i/2,e.castShadow=!0,h.add(e)}if(!(2>j)){var p=.01,q=.01;for(f=1;i-1>=f;f++)e=new THREE.Mesh(Part.CUBE,Materials.SEM),e.position.x=.49,e.position.y=((j-1)/2+k)*l,e.position.z=-i/2+f,e.scale.set(p,(j-1)*l,p),e.rotation.set(PRNG.random()*q,PRNG.random()*q,PRNG.random()*q),h.add(e),e=new THREE.Mesh(Part.CUBE,Materials.SEM),e.position.x=-.49,e.position.y=((j-1)/2+k)*l,e.position.z=-i/2+f,e.scale.set(p,(j-1)*l,p),e.rotation.set(PRNG.random()*q,PRNG.random()*q,PRNG.random()*q),h.add(e);
a.type==T.ENGINE&&(h.position.x+=.25),a.add(h)}};Cardinal.compute=function(a,b,c,d,e){b=Math.max(.01,Math.min(1,b||.1)),c=Math.max(-5,Math.min(5,c||0)),d=d||!1,e=e||[];var f,g;for(f=0;f<a.length-(d?0:1);f++)for(p0=1>f?a[a.length-1]:a[f-1],p1=a[f],p2=a[(f+1+a.length)%a.length],p3=a[(f+2+a.length)%a.length],g=0;1>g;g+=b)e.push(new THREE.Vector3(c*(-g*g*g+2*g*g-g)*p0.x+c*(-g*g*g+g*g)*p1.x+(2*g*g*g-3*g*g+1)*p1.x+c*(g*g*g-2*g*g+g)*p2.x+(-2*g*g*g+3*g*g)*p2.x+c*(g*g*g-g*g)*p3.x,c*(-g*g*g+2*g*g-g)*p0.y+c*(-g*g*g+g*g)*p1.y+(2*g*g*g-3*g*g+1)*p1.y+c*(g*g*g-2*g*g+g)*p2.y+(-2*g*g*g+3*g*g)*p2.y+c*(g*g*g-g*g)*p3.y,c*(-g*g*g+2*g*g-g)*p0.z+c*(-g*g*g+g*g)*p1.z+(2*g*g*g-3*g*g+1)*p1.z+c*(g*g*g-2*g*g+g)*p2.z+(-2*g*g*g+3*g*g)*p2.z+c*(g*g*g-g*g)*p3.z));return e.push(d?e[0]:a[a.length-1]),e},CatmullRom.compute=function(a,b,c,d){b=Math.max(.001,Math.min(.999,b||.1)),c=c||!1,d=d||[],d.push(new THREE.Vector3(a[0].x,a[0].y,a[0].z));var e,f;for(e=0;e<a.length-(c?0:1);e++)for(p0=a[(e-1+a.length)%a.length],p1=a[e],p2=a[(e+1+a.length)%a.length],p3=a[(e+2+a.length)%a.length],f=b;1>f;f+=b)d.push(new THREE.Vector3(.5*(2*p1.x+f*(-p0.x+p2.x+f*(2*p0.x-5*p1.x+4*p2.x-p3.x+f*(-p0.x+3*p1.x-3*p2.x+p3.x)))),.5*(2*p1.y+f*(-p0.y+p2.y+f*(2*p0.y-5*p1.y+4*p2.y-p3.y+f*(-p0.y+3*p1.y-3*p2.y+p3.y)))),.5*(2*p1.z+f*(-p0.z+p2.z+f*(2*p0.z-5*p1.z+4*p2.z-p3.z+f*(-p0.z+3*p1.z-3*p2.z+p3.z))))));var g=a[a.length-1];return c&&(g=a[0]),d.push(new THREE.Vector3(g.x,g.y,g.z)),d},QuadraticBezier.compute=function(a,b,c,d){b=Math.max(.01,Math.min(1,b||.1)),c=c||!1,d=d||[];for(var e,f,g,h,i,j,k,l,m=(new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,0);m<a.length;){for(0==m?1==c?(p0.x=.5*(a[a.length-1].x+a[m].x),p0.y=.5*(a[a.length-1].y+a[m].y),p0.z=.5*(a[a.length-1].z+a[m].z)):(p0.x=a[m].x,p0.y=a[m].y,p0.z=a[m].z):(p0.x=.5*(a[m-1].x+a[m].x),p0.y=.5*(a[m-1].y+a[m].y),p0.z=.5*(a[m-1].z+a[m].z)),p1.x=a[m].x,p1.y=a[m].y,p1.z=a[m].z,m==a.length-1?1==c?(p2.x=.5*(a[m].x+a[0].x),p2.y=.5*(a[m].y+a[0].y),p2.z=.5*(a[m].z+a[0].z)):(p2.x=a[m].x,p2.y=a[m].y,p2.z=a[m].z):(p2.x=.5*(a[m+1].x+a[m].x),p2.y=.5*(a[m+1].y+a[m].y),p2.z=.5*(a[m+1].z+a[m].z)),e=0;1>e;)f=1-e,g=f*f,h=2*e*f,i=e*e,j=g*p0.x+h*p1.x+i*p2.x,k=g*p0.y+h*p1.y+i*p2.y,l=g*p0.z+h*p1.z+i*p2.z,d.push(new THREE.Vector3(j,k,l)),e+=b;m++}return d.push(c?d[0]:a[a.length-1]),d};var Section=function(a,b){this.points=a;for(var c=[],d=[],e=new THREE.Vector2(Math.POSITIVE_INFINITY,Math.POSITIVE_INFINITY),f=new THREE.Vector2(Math.NEGATIVE_INFINITY,Math.NEGATIVE_INFINITY),g=0;g<a.length;g++){var h=a[g],i=new THREE.Vector3(h.x,h.y,0);c.push(i),h.x<e.x&&(e.x=h.x),h.y<e.y&&(e.y=h.y),h.x>f.x&&(f.x=h.x),h.y>f.y&&(f.y=h.y)}1/(f.x-e.x),1/(f.y-e.y);for(g=0;g<a.length;g++)h=a[g],d.push(new THREE.Vector2(norm(h.x,e.x,f.x),norm(h.y,e.y,f.y)));var j=new THREE.Geometry;j.vertices=c,j.uvs=d,j.uvsNeedUpdate=j.verticesNeedUpdate=!0,this.getFaces(j),THREE.Mesh.call(this,j,b)};Section.prototype=Object.create(THREE.Mesh.prototype),Section.prototype.getFaces=function(a){var b,c=a.vertices;try{b=POLYGON.tessellate(c,[[]])}catch(d){try{c.reverse(),b=POLYGON.tessellate(c,[[]])}catch(d){return void c.reverse()}c.reverse()}for(var e=0;e<b.length;e++){var f=b[e],g=f[0],h=f[1],i=f[2];a.faces.push(new THREE.Face3(g,h,i)),null!=a.uvs&&a.faceVertexUvs[0].push([a.uvs[g],a.uvs[h],a.uvs[i]]),a.faces.push(new THREE.Face3(h,g,i)),null!=a.uvs&&a.faceVertexUvs[0].push([a.uvs[h],a.uvs[g],a.uvs[i]])}return a.computeFaceNormals(),a.computeVertexNormals(),a},Section.createRegularSection=function(a,b,c){a=a||50,b=Math.max(3,b||12);for(var d=[],e=0;b>e;e++){var f=2*e*Math.PI/b;d.push(new THREE.Vector2(Math.cos(f)*a,Math.sin(f)*a))}return new Section(d,c,!1)},Section.offset=function(a,b,c){var d,e;for(d=0;d<a.geometry.vertices.length;d++)e=a.geometry.vertices[d],e[b]+=c;return a.geometry.verticesNeedUpdate=!0,a},Section.switchAxis=function(a,b,c){var d,e,f;for(d=0;d<a.vertices.length;d++)e=a.vertices[d],f=e[c],e[c]=e[b],e[b]=f;for(d=0;d<a.structure.length;d++)e=a.structure[d],f=e[c],e[c]=e[b],e[b]=f;return a},Section.flipAxis=function(a,b){var c,d;for(c=0;c<a.vertices.length;c++)d=a.vertices[c],d[b]*=-1;for(c=0;c<a.structure.length;c++)d=a.structure[c],d[b]*=-1;return a};var Caps=function(){};Caps.getFaces=function(a,b,c){var d,e;if(null==b||null==c)d=a.vertices.concat(),b=0,c=d.length;else for(d=[],c=c||d.length,e=b;c>e;e++)d.push(a.vertices[e]);var f;try{f=POLYGON.tessellate(d,[[]])}catch(g){try{d.reverse(),f=POLYGON.tessellate(d,[[]])}catch(g){return a.computeFaceNormals(),void a.computeVertexNormals()}}for(e=0;e<f.length;e++){var h=f[e];if(null==h)break;var i=b+h[0],j=b+h[1],k=b+h[2];a.faces.push(new THREE.Face3(i,j,k)),null!=a.uvs&&a.faceVertexUvs[0].push([a.uvs[i],a.uvs[j],a.uvs[k]]),a.faces.push(new THREE.Face3(j,i,k)),null!=a.uvs&&a.faceVertexUvs[0].push([a.uvs[j],a.uvs[i],a.uvs[k]])}return a.computeFaceNormals(),a.computeVertexNormals(),a};var Delaunay=function(){this.EPSILON=1e-5,this.SUPER_TRIANGLE_RADIUS=1e6,this.compute=function(a){a.sort(function(a,b){return a.x<b.x?-1:1}),this.indices=[],this.circles=[];var b=a.length;if(3>b)return null;var c=this.SUPER_TRIANGLE_RADIUS;a.push(new Point(0,-c)),a.push(new Point(c,c)),a.push(new Point(-c,c)),this.indices=[],this.indices.push(a.length-3),this.indices.push(a.length-2),this.indices.push(a.length-1),this.circles=[],this.circles.push(0),this.circles.push(0),this.circles.push(c);var d,e,f,g,h,i,j=[];for(d=0;b>d;d++){for(e=0;e<this.indices.length;)this.circles[e+2]>this.EPSILON&&this.circleContains(e,a[d])&&(g=this.indices[e],h=this.indices[e+1],i=this.indices[e+2],j.push(g),j.push(h),j.push(h),j.push(i),j.push(i),j.push(g),this.indices.splice(e,3),this.circles.splice(e,3),e-=3),e+=3;for(e=0;e<j.length;){for(f=e+2;f<j.length;){if(j[e]==j[f]&&j[e+1]==j[f+1]||j[e+1]==j[f]&&j[e]==j[f+1]){if(j.splice(f,2),j.splice(e,2),e-=2,f-=2,0>e||e>j.length-1)break;if(0>f||f>j.length-1)break}f+=2}e+=2}for(e=0;e<j.length;)this.indices.push(j[e]),this.indices.push(j[e+1]),this.indices.push(d),this.computeCircle(a,j[e],j[e+1],d),e+=2;j=[]}for(g=a.length-3,h=a.length-2,i=a.length-1,d=0;d<this.indices.length;)this.indices[d]!=g&&this.indices[d]!=h&&this.indices[d]!=i&&this.indices[d+1]!=g&&this.indices[d+1]!=h&&this.indices[d+1]!=i&&this.indices[d+2]!=g&&this.indices[d+2]!=h&&this.indices[d+2]!=i?d+=3:(this.indices.splice(d,3),this.circles.splice(d,3),d>0&&(d-=3));return a.pop(),a.pop(),a.pop(),this.indices},this.circleContains=function(a,b){var c=this.circles[a]-b.x,d=this.circles[a+1]-b.y;return this.circles[a+2]>c*c+d*d},this.computeCircle=function(a,b,c,d){var e=a[b],f=a[c],g=a[d],h=f.x-e.x,i=f.y-e.y,j=g.x-e.x,k=g.y-e.y,l=h*(e.x+f.x)+i*(e.y+f.y),m=j*(e.x+g.x)+k*(e.y+g.y),n=2*(h*(g.y-f.y)-i*(g.x-f.x)),o=(k*l-i*m)/n;this.circles.push(o);var p=(h*m-j*l)/n;this.circles.push(p),o-=e.x,p-=e.y,this.circles.push(o*o+p*p)}},Extrude=function(a,b,c,d,e){var f=new THREE.Geometry;d=d||2;var g,h,i,j,k,l,m,n=null==b.geometry?b:b.geometry.vertices,o=n.length,p=Array.expand2D([0,1],[0,1],o*d,o),q=[],r=0,s=c/d,t=new THREE.Vector3;for(h=0;d>=h;h++){if(t.copy(a),t.multiplyScalar(h*s),n.forEach(function(a){var b=new THREE.Vector3(a.x,a.y,a.z);b.add(t),q.push(b)}),r>0)for(g=r-o,i=0;o>i;i++)j=g+i,k=g+(i+1)%o,l=r+i,m=r+(i+1)%o,f.faces.push(new THREE.Face3(k,j,l)),f.faces.push(new THREE.Face3(k,l,m)),f.faceVertexUvs[0].push([p[k],p[j],p[l]]),f.faceVertexUvs[0].push([p[k],p[l],p[m]]);r+=o}f.vertices=q,f.uvs=p,f.verticesNeedUpdate=f.uvsNeedUpdate=!0,Caps.getFaces(f,0,o),Caps.getFaces(f,q.length-o,q.length),THREE.Mesh.call(this,f,e),this.castShadow=!0};Extrude.prototype=Object.create(THREE.Mesh.prototype);var Lathe=function(a,b,c,d,e){var f=new THREE.Geometry;c=c||3;var g=null==b.geometry?b:b.geometry.vertices;console.log();var h,i,j,k,l,m,n,o=g.length,p=Array.expand2D([0,1],[0,1],c+1,o),q=0,r=[],s=0,t=(e||2*Math.PI)/c,u=new THREE.Matrix4;for(i=0;c>=i;i++){if(s=i*t+Math.PI,u.identity(),u.makeRotationAxis(a,s),g.forEach(function(a){var b=new THREE.Vector3(a.x,a.y,a.z);b.applyMatrix4(u),r.push(b)}),q>0)for(h=q-o,j=0;o>j;j++)k=h+j,l=h+(j+1)%o,m=q+j,n=q+(j+1)%o,f.faces.push(new THREE.Face3(l,k,m)),f.faces.push(new THREE.Face3(l,m,n)),f.faceVertexUvs[0].push([p[l],p[k],p[m]]),f.faceVertexUvs[0].push([p[l],p[m],p[n]]);q+=o}f.vertices=r,f.uvs=p,f.verticesNeedUpdate=f.uvsNeedUpdate=!0,f.computeFaceNormals(),f.computeVertexNormals(),THREE.Mesh.call(this,f,d)};Lathe.prototype=Object.create(THREE.Mesh.prototype);var Loft=function(a,b,c){var d=new THREE.Geometry,e=null==b.geometry?b:b.geometry.vertices,f=e.length,g=Array.expand2D([0,1],[0,1],a.length,f);this.sectionVertices=e,this.sides=f;var h,i,j,k,l,m,n,o,p,q=new THREE.Vector3(0,0,1),r=0,s=[],t=new THREE.Matrix4;for(k=0;k<a.length;k++){if(h=a[k],i=a[k+1>=a.length?k:k+1],t.identity(),t.setPosition(h),t.lookAt(h,i,q),e.forEach(function(a){var b=new THREE.Vector3(a.x,a.y,a.z);b.applyMatrix4(t),s.push(b)}),r>0)for(j=r-f,l=0;f>l;l++)m=j+l,n=j+(l+1)%f,o=r+l,p=r+(l+1)%f,d.faces.push(new THREE.Face3(n,m,o)),d.faces.push(new THREE.Face3(n,o,p)),d.faceVertexUvs[0].push([g[n],g[m],g[o]]),d.faceVertexUvs[0].push([g[n],g[o],g[p]]);r+=f}d.vertices=s,d.uvs=g,d.verticesNeedUpdate=d.uvsNeedUpdate=!0,Caps.getFaces(d,0,f),Caps.getFaces(d,s.length-f,s.length),THREE.Mesh.call(this,d,c)};Loft.prototype=Object.create(THREE.Mesh.prototype),Loft.prototype.update=function(a){var b,c,d=this.geometry.vertices,e=new THREE.Vector3(0,0,1),f=new THREE.Matrix4;for(i=0;i<a.length;i++){b=a[i],c=a[i+1>=a.length?i:i+1],f.identity(),f.setPosition(b),f.lookAt(b,c,e);for(var g=0;g<this.sectionVertices.length;g++)d[i*this.sides+g].copy(this.sectionVertices[g]),d[i*this.sides+g].applyMatrix4(f)}this.geometry.verticesNeedUpdate=!0,this.geometry.computeFaceNormals(),this.geometry.computeVertexNormals()};var Profile=function(){this.vertices=[],this.structure=[]};Profile.prototype={clone:function(){var a=new Profile;return this.vertices.forEach(function(b){a.vertices.push(b.clone())}),this.structure.forEach(function(b){a.structure.push(b.clone())}),a}},Profile.getWingTip=function(a,b,c,d,e){{var f=new Profile,g=f.vertices,h=f.structure,i=new Point(0,0);new Point(a,0),new Point(0,b)}g.push(i),h.push(i.clone());for(var j,k,l=c/d/2,m=0,n=0;c>=n;n+=l)m++%2==0?(j=new Point(i.x+Math.cos(n)*a,i.y+Math.sin(n)*b),g.push(j),1>e?(k=new Point(i.x+Math.cos(n)*a*(2-e),i.y+Math.sin(n)*b*(2-e)),h.push(i.clone(),k)):h.push(i.clone(),j.clone())):(j=new Point(i.x+Math.cos(n)*a*e,i.y+Math.sin(n)*b*e),g.push(j),e>1&&h.push(i.clone(),j.clone()));return f},Profile.getWingModule=function(a,b,c,d){{var e=new Profile,f=e.vertices,g=e.structure,h=new Point(0,0);new Point(a,0),new Point(0,b)}f.push(h),g.push(h.clone());for(var i,j,k=b/c/2,l=0,m=0;b>=m;m+=k)i=l++%2==0?new Point(h.x+a,h.y+m):new Point(h.x+a*(2-d),h.y+m),f.push(i),j=new Point(h.x,m),g.push(i.clone(),j);return e},Profile.offset=function(a,b,c){var d,e;for(d=0;d<a.vertices.length;d++)e=a.vertices[d],e[b]+=c;for(d=0;d<a.structure.length;d++)e=a.structure[d],e[b]+=c;return a},Profile.switchAxis=function(a,b,c){var d,e,f;for(d=0;d<a.vertices.length;d++)e=a.vertices[d],f=e[c],e[c]=e[b],e[b]=f;for(d=0;d<a.structure.length;d++)e=a.structure[d],f=e[c],e[c]=e[b],e[b]=f;return a},Profile.flipAxis=function(a,b){var c,d;for(c=0;c<a.vertices.length;c++)d=a.vertices[c],d[b]*=-1;for(c=0;c<a.structure.length;c++)d=a.structure[c],d[b]*=-1;return a};var Simplify={};Simplify.compute=function(a,b){var c=Date.now();if(null==a||a.length<3)return a;for(var d=0,e=a.length-1,f=[d,e];a[d].x==a[e].x&&a[d].y==a[e].y;)e--;Simplify.reduce(a,d,e,b,f);var g=[];return f.sort(function(a,b){return b>a?-1:1}),f.forEach(function(b){g.push(a[b])}),console.log("simplify",Date.now()-c,"ms"),g},Simplify.reduce=function(a,b,c,d,e){for(var f=0,g=0,h=b;c>h;h++){var i=Simplify.perpendicularDistance(a[b],a[c],a[h]);i>f&&(f=i,g=h)}f>d&&0!=g&&(e.push(g),Simplify.reduce(a,b,g,d,e),Simplify.reduce(a,g,c,d,e))},Simplify.perpendicularDistance=function(a,b,c){var d=Math.abs(.5*(a.x*b.y+b.x*c.y+c.x*a.y-b.x*a.y-c.x*b.y-a.x*c.y)),e=Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2));return d/e*2};var POLYGON,__indexOf=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};POLYGON={},POLYGON.tessellate=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,ab,bb,cb,db,eb,fb,gb,hb;if(M=POLYGON.vec2,c=new M,f=new M,h=new M,e=new M,g=new M,k=new M,d=new M,E=function(a,b){var d,i,j;return c.sub(b[1],b[0]),f.sub(b[2],b[1]),h.sub(b[0],b[2]),e.sub(a,b[0]),g.sub(a,b[1]),k.sub(a,b[2]),d=c.cross(e),i=f.cross(g),j=h.cross(k),0>d&&0>i&&0>j?!0:d>0&&i>0&&j>0?!0:!1},v=function(a,b,e){return d.sub(e,a),c.sub(b,a),0>d.cross(c)},t=function(a,b,c){var d;return a.y===b.y?a.x:a.y<b.y?(d=(c-a.y)/(b.y-a.y),a.x+d*(b.x-a.x)):(d=(c-b.y)/(a.y-b.y),b.x+d*(a.x-b.x))},a.length<3)return[];if(3===a.length&&0===b.length)return[0,1,2];if(I=[],F=function(){hb=[];for(var b=0,c=a.length;c>=0?c>b:b>c;c>=0?b++:b--)hb.push(b);return hb}.apply(this),J=0,o=function(b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,u,v,w,x,y,z,A,B,C,D,G,H,J,K;for(f=0,z=-1e4,q=A=0,D=b.length;D>A;q=++A)n=b[q],n.x>z&&(z=n.x,f=q);for(e=b[f],c=1e-4,d=new M(1e4,e.y),g=new M,h=-1,r=B=0,G=a.length;G>B;r=++B)l=a[r],s=(r+1)%a.length,m=a[s],l.x<e.x&&m.x<e.x||l.x>d.x&&m.x>d.x||(l.y<=(J=e.y)&&J<=m.y||m.y<=(K=e.y)&&K<=l.y)&&(y=t(l,m,e.y),y<d.x&&(d.x=y,l.x>m.x?(g=l,h=r):(g=m,h=s)));for(x=[e,d,g],k=1e3,j=-1,u=C=0,H=F.length;H>C;u=++C)if(q=F[u],I[u]&&(i=a[q],E(i,x))){if(p=Math.abs(i.y-g.y),o=Math.abs(i.x-g.x),0===o)continue;w=p/o,k>w&&(k=w,j=q)}return-1!==j&&(h=j),v=[h,f]},n=function(a){var b,c;return c=(a+F.length-1)%F.length,b=(a+1)%F.length,[c,b]},i=function(b){var c,d,e,f,g,h,i,j,k,l,m,o;if(0===J)return!0;for(o=n(b),i=o[0],h=o[1],j=[i,b,h],f=function(){var a,b,c;for(c=[],a=0,b=j.length;b>a;a++)g=j[a],c.push(F[g]);return c}(),k=function(){var b,d,e;for(e=[],b=0,d=f.length;d>b;b++)c=f[b],e.push(a[c]);return e}(),d=!0,g=l=0,m=F.length;m>l;g=++l)if(e=F[g],!(__indexOf.call(f,e)>=0)&&I[g]&&E(a[e],k)){d=!1;break}return d},w=function(b){var c,d,e,f,g,h;return h=n(b),g=h[0],f=h[1],c=a[F[g]],d=a[F[b]],e=a[F[f]],v(c,d,e)},K=[],null!=b&&b[0].length>=3){for(B=R=0,U=F.length;U>R;B=++R)x=F[B],I.push(w(B));for(q=b[0],K=o(q),a=a.slice(0),r=a.length,S=0,V=q.length;V>S;S++)p=q[S],a.push(p);for(z=[],s=(K[0]+1)%F.length,Q=T=0,db=F.length;db>=0?db>T:T>db;Q=db>=0?++T:--T)z.push(F[s]),s=(s+1)%F.length;for(s=K[1],Q=$=0,eb=q.length;eb>=0?eb>$:$>eb;Q=eb>=0?++$:--$)z.push(r+s),s=(s+1)%q.length;z.push(z[F.length]),z.push(z[F.length-1]),F=z}for(j=[],I=[],J=0,B=_=0,W=F.length;W>_;B=++_)x=F[B],w(B)?(I.push(!0),J+=1):(I.push(!1),j.push(B));for(m=[],ab=0,X=j.length;X>ab;ab++)B=j[ab],i(B)&&m.push(B);for(N=!1,N&&(console.info(""),console.info("ears    "+m),console.info("reflex  "+I),console.info("convex  "+j)),L=[];F.length>0;){for(C=m.pop(),P-=1,fb=n(C),G=fb[0],D=fb[1],H=[G,C,D],A=function(){var a,b,c;for(c=[],b=0,a=H.length;a>b;b++)B=H[b],c.push(F[B]);return c}(),L.push(A),F.splice(C,1),I.splice(C,1),s=bb=0,Y=m.length;Y>bb;s=++bb)B=m[s],B>C&&(m[s]=m[s]-1);for(D>C&&(D-=1),G>C&&(G-=1),gb=[G,D],cb=0,Z=gb.length;Z>cb;cb++)y=gb[cb],I[y]&&!w(y)&&(I[y]=!1,J-=1),I[y]||(u=i(y),l=m.indexOf(y),O=-1!==l,u&&!O?m.push(y):!u&&O&&m.splice(l,1))}return L},POLYGON.vec2=function(a,b){this.x=a||0,this.y=b||0},POLYGON.vec2.prototype={constructor:POLYGON.vec2,set:function(a,b){return this.x=a,this.y=b,this},copy:function(a){return this.x=a.x,this.y=a.y,this},add:function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this},sub:function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this},multiplyScalar:function(a){return this.x*=a,this.y*=a,this},divideScalar:function(a){return a?(this.x/=a,this.y/=a):this.set(0,0),this},negate:function(){return this.multiplyScalar(-1)},dot:function(a){return this.x*a.x+this.y*a.y},cross:function(a){return this.x*a.y-this.y*a.x},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.lengthSq())},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(a){return Math.sqrt(this.distanceToSquared(a))},distanceToSquared:function(a){var b=this.x-a.x,c=this.y-a.y;return b*b+c*c},setLength:function(a){return this.normalize().multiplyScalar(a)},lerpSelf:function(a,b){return this.x+=(a.x-this.x)*b,this.y+=(a.y-this.y)*b,this},equals:function(a){return a.x===this.x&&a.y===this.y},isZero:function(a){return this.lengthSq()<(void 0!==a?a:1e-4)},clone:function(){return new POLYGON.vec2(this.x,this.y)}};var Skybox=function(){var a=new THREE.CubeTexture([]);a.format=THREE.RGBFormat,a.flipY=!1,Skybox.cubeMap=a;var b=new THREE.ImageLoader;b.load("img/envmap.png",function(b){var c=function(a,c){var d=64,e=document.createElement("canvas");e.width=d,e.height=d;var f=e.getContext("2d");return f.drawImage(b,-a*d,-c*d),e};a.images[0]=c(2,1),a.images[1]=c(0,1),a.images[2]=c(1,0),a.images[3]=c(1,2),a.images[4]=c(1,1),a.images[5]=c(3,1),a.needsUpdate=!0});var c=THREE.ShaderLib.cube;c.uniforms.tCube.value=a,Skybox.material=new THREE.ShaderMaterial({fragmentShader:c.fragmentShader,vertexShader:c.vertexShader,uniforms:c.uniforms,depthWrite:!1,side:THREE.BackSide});var d=new THREE.Mesh(new THREE.BoxGeometry(1e3,1e3,1e3),Skybox.material);Stage3d.scene.add(d)},World=function(a){this.container=new THREE.Object3D,a.add(this.container),World.GlobeGeometry=new THREE.SphereGeometry(1,128,64),this.globe=new THREE.Mesh(World.GlobeGeometry,Materials.GLOBE),this.container.add(this.globe);var b=this.worldScale=100;this.container.scale.multiplyScalar(b),World.globe=this.globe,this.monuments={united_kingdom:{type:T.MONUMENT,scale:1,id:"Stonehenge",latlng:[51.17901,-1.826227],url:"assets/monuments/stonehenge.js"},italia:{type:T.MONUMENT,scale:.35,name:"Colosseo",latlng:[41.890434,12.492167],url:"assets/monuments/colosseum.js"},egypt:{type:T.MONUMENT,id:"Giza Sphinx",scale:1.5,latlng:[29.975255,31.137304],url:"assets/monuments/sphinx.js"},india:{type:T.MONUMENT,scale:.75,id:"Taj Mahal",latlng:[27.17513,78.042134],url:"assets/monuments/taj_mahal.js"},australia:{type:T.MONUMENT,scale:.4,id:"Sydney Opera House",latlng:[-33.856684,151.215292],url:"assets/monuments/sydney_opera_house.js"},mexico:{type:T.MONUMENT,scale:.85,id:"Chichen Itza",latlng:[20.684576,-88.567762],url:"assets/monuments/chichen_itza.js"},usa:{type:T.MONUMENT,scale:.75,id:"statue of liberty",latlng:[40.689461,-74.044511],url:"assets/monuments/statue_of_liberty.js"}};var c,d=[];for(key in this.monuments){var e=this.monuments[key];c=MathUtils.lonLatToVector3(e.latlng[1]*RAD,e.latlng[0]*RAD),d.push(c.clone())}for(var f=0;f<2*Math.PI-20*RAD;f+=20*RAD){var g=f,h=Math.random()*Math.PI/4-Math.PI/8;c=MathUtils.lonLatToVector3(g,h),d.push(c.clone())}d=CatmullRom.compute(d,.01,!0),d.forEach(function(a){a.normalize().multiplyScalar(1.115*b)});var i=new THREE.SplineCurve3(d);this.curve=i};World.prototype={set visible(a){this.container.visible=a},get visible(){return this.container.visible},init:function(){var a=this,b=[];for(var c in this.monuments)b.push(this.monuments[c]);new GeometryLoader(b,a,"onMeshLoaded","onLoadComplete")},onMeshLoaded:function(a,b){b.computeFaceNormals();var c=new THREE.Mesh(b,Materials.MONUMENT),d=35e-6*a.scale;c.scale.multiplyScalar(1e-9),c.rotation.x=-Math.PI/2,TweenLite.to(c.scale,1,{x:d,y:d,z:d});var e=new THREE.Object3D;e.add(c);var f=MathUtils.lonLatToVector3(a.latlng[1]*RAD,a.latlng[0]*RAD).multiplyScalar(1.0035);e.position.copy(f),e.lookAt(ZERO),this.container.add(e)},onLoadComplete:function(){new Sound}},PRNG.initialize_generator=function(a){for(this.MT=new Uint32Array(624),this.index=0,this.MT[0]=a,i=1;624>i;i++)this.MT[i]=1812433253*(this.MT[i-1]^(this.MT[i-1]>>30)+i)},PRNG.extract_number=function(){0==this.index&&this.generate_numbers();var a=this.MT[this.index];return a^=a>>11,a^=a<<7&2636928640,a^=a<<15&4022730752,a^=a>>18,this.index=(this.index+1)%624,a},PRNG.generate_numbers=function(){for(var a=0;624>a;a++){var b=(2147483648&this.MT[a])+(2147483647&this.MT[(a+1)%624]);this.MT[a]=this.MT[(a+397)%624]^b>>1,b%2!=0&&(this.MT[a]=2567483615^this.MT[a])}},PRNG.random=function(){return this.extract_number()/2147483647},PRNG.initialize_generator(0);var Point=function(a,b,c){this.x=a||0,this.y=b||0,this.z=c||0};Point.prototype={clone:function(){return new Point(this.x,this.y,this.z)},multiplyScalar:function(a){return this.x*=a,this.y*=a,this.z*=a,this}},Array.expand=function(a,b){var c,d=[];if(1==a.length){for(c=b;c--;)d.push(a[0]);return d}var e=1/((a.length-1)/(b-1));for(c=0;b>c;c+=e){var f=a[parseInt(c/e)],g=parseInt(c/e)+1;g>a.length-1&&(g=a.length-1);for(var h=a[g],i=c+e>b?b-c:e,j=0;i>j;j++)d.push(f+(h-f)*(j/i))}for(;d.length<b;)d.push(a[a.length-1]);return d},Array.expand2D=function(a,b,c,d){for(var e=Array.expand(a,c),f=Array.expand(b,d),g=[],h=0;c>h;h++)for(var i=0;d>i;i++)g.push(new THREE.Vector2(e[h],f[i]));return g},Array.expand3D=function(a,b,c,d,e,f){for(var g=Array.expand(a,d),h=Array.expand(b,e),i=Array.expand(c,f),j=[],k=0;d>k;k++)for(var l=0;e>l;l++)for(var m=0;f>m;m++)j.push(new THREE.Vector3(g[k],h[l],i[m]));return j};var CanvasNoise=function(a,b,c,d,e,f){c=c||0,d=d||255;var g=d-c;e=null!=e&&1==e,f=null!=f&&1==f;var h=document.createElement("canvas");h.width=a,h.height=b;for(var i=h.getContext("2d"),j=i.getImageData(0,0,a,b),k=j.data,l=0;l<k.length;l+=4){if(e)k[l]=c+parseInt(Math.random()*g),k[l+1]=c+parseInt(Math.random()*g),k[l+2]=c+parseInt(Math.random()*g);else{var m=c+parseInt(Math.random()*g);k[l]=k[l+1]=k[l+2]=m}k[l+3]=f?parseInt(255*Math.random()):255}return i.putImageData(j,0,0),h},PI2=2*Math.PI,RAD=Math.PI/180,DEG=180/Math.PI,ZERO=new THREE.Vector3,Sound=function(){Sound.instance=this,Sound.playin=!1,Sound.soundtrack=new Howl({urls:["assets/snd/soundtrack.mp3","assets/snd/soundtrack.ogg"],loop:!0,volume:.5,onend:function(){},onload:function(){var a=document.getElementById("sound");TweenLite.to(a,1,{opacity:1}),new Hammer(a).on("tap",function(){Sound.playing?Sound.soundtrack.fadeOut(0,1e3):Sound.soundtrack.fadeIn(.5,2e3),Sound.playing=!Sound.playing}),this.fadeIn(.5,2e3),Sound.playing=!0}})};Sound.mute=function(){Sound.soundtrack.fadeOut(0,500)};var left=document.getElementById("left"),right=document.getElementById("right"),down=document.getElementById("down");window.onload=function(){window.hasGL=webgl_detect(!1),init(window.hasGL)};